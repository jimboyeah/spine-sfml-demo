
# ğŸš© OOP é¢å‘å¯¹è±¡ç¼–ç¨‹

é¢å‘å¯¹è±¡ä¸‰å¤§ç‰¹å¾ï¼š 

- å°è£…ï¼šEncapsulationï¼Œå°è£…å’Œéšè—

    - â— ç¼˜ç”±ï¼šä½¿ç”¨è€…å¯¹å®šä¹‰çš„å±æ€§(æˆå‘˜å˜é‡)ç›´æ¥æ“ä½œä¼šå¯¼è‡´æ•°æ®çš„é”™è¯¯ã€æ··ä¹±æˆ–å®‰å…¨æ€§é—®é¢˜
    - â— åŠæ³•ï¼šéšè—ä¸éœ€è¦å¯¹å¤–æä¾›çš„å®ç°ç»†èŠ‚ï¼Œä½¿ç”¨è€…åªèƒ½é€šè¿‡äº‹å…ˆå®šåˆ¶å¥½çš„æ–¹æ³•æ¥è®¿é—®
    - â— å®ç°ï¼šå°†å±æ€§å£°æ˜ä¸ºç§æœ‰çš„ï¼Œå†æä¾›å…¬å…±çš„æ–¹æ³•å®ç°å¯¹è¯¥å±æ€§çš„æ“ä½œ

- ç»§æ‰¿ï¼šInheritance

    - â— å¤šä¸ªç±»ä¸­å­˜åœ¨ç›¸åŒå±æ€§å’Œè¡Œä¸ºæ—¶ï¼Œå°†è¿™äº›å†…å®¹æŠ½å–åˆ°ä¸€ä¸ªæ–°ç±»ä¸­ï¼Œå¤šä¸ªç±»æ— éœ€å†å®šä¹‰è¿™äº›å±æ€§å’Œè¡Œä¸ºï¼Œåªè¦ç»§æ‰¿é‚£ä¸ªç±»å³å¯
    - â— å­ç±»ä¼šæŠŠçˆ¶ç±»é™¤æ„é€ å™¨ä¹‹å¤–çš„æ‰€æœ‰ä¿¡æ¯ç»™ç»§æ‰¿ä¸‹æ¥
    - â— å­çˆ¶ç±»çš„æ¦‚å¿µæ˜¯ç›¸å¯¹çš„ï¼ˆå­ç±»ä¹Ÿå¯ä»¥ä½œä¸ºå…¶ä»–ç±»çš„çˆ¶ç±»ï¼Œçˆ¶ç±»ä¹Ÿå¯ä»¥ä½œä¸ºå…¶ä»–ç±»çš„å­ç±»ï¼‰
    - â— å­ç±»å¯ä»¥æœ‰è‡ªå·±ç‰¹æœ‰å±æ€§å’Œæ–¹æ³•ä¹Ÿå¯ä»¥é‡å†™çˆ¶ç±»å®šä¹‰çš„æ–¹æ³•
    - â— å­ç±»æ˜¯çˆ¶ç±»çš„æ‰©å±•
    - â— è¯­æ³•ï¼š ä¿®é¥°ç¬¦  class  ç±»å(å­ç±»)  extends  ç±»å(çˆ¶ç±»){ }
    - â— ä½œç”¨ ï¼šæé«˜äº†ä»£ç çš„å¤ç”¨æ€§ï¼Œè®©ç±»ä¸ç±»ä¹‹é—´äº§ç”Ÿäº†å…³ç³»ï¼Œæä¾›äº†å¤šæ€çš„å‰æ

- å¤šæ€ï¼šPolymorphismï¼ŒæŒ‡ä¸€ä¸ªäº‹ç‰©å­˜åœ¨å¤šç§å½¢æ€

    - è¡¨ç°å½¢å¼ï¼š

        - â— æ–¹æ³•çš„é‡è½½å’Œé‡å†™ overload & override
        - â— å¯¹è±¡çš„å¤šæ€æ€§ï¼šçˆ¶ç±»çš„å¼•ç”¨æŒ‡å‘å­ç±»çš„å¯¹è±¡  å¦‚ï¼šPerson p1 = new Woman();

    - å¤šæ€çš„å‰æï¼š

        - â— ç»§æ‰¿å…³ç³»
        - â— å­ç±»é‡å†™äº†çˆ¶ç±»çš„æ–¹æ³•

    - å¤šæ€åœ¨ç¨‹åºè¿è¡Œåˆ†ä¸ºï¼šï¼ˆç¼–è¯‘æ—¶â€œçœ‹å·¦è¾¹â€ï¼Œè¿è¡Œæ—¶â€œçœ‹å³è¾¹â€ï¼‰

        - â— ç¼–è¯‘çŠ¶æ€ ï¼šå…³æ³¨æ˜¯çˆ¶ç±»ã€‚å­ç±»ç‰¹æœ‰çš„å±æ€§å’Œæ–¹æ³•ä¸èƒ½è¢«ç¼–è¯‘é€šè¿‡
        - â— è¿è¡ŒçŠ¶æ€ ï¼šå…³æ³¨çš„æ˜¯å­ç±»ï¼ˆçœŸæ­£å¯¹è±¡çš„å®ä½“ï¼Œå­ç±»çš„å¯¹è±¡ï¼Œé‚£ä¹ˆæ‰§è¡Œçš„æ–¹æ³•å°±æ˜¯å­ç±»é‡å†™çš„æ–¹æ³•ï¼‰

æŠ½è±¡æ˜¯äººç±»è§£å†³é—®é¢˜çš„ä¸€ç§é«˜åº¦æ€ç»´èƒ½åŠ›ï¼ŒæŠ½è±¡åœ¨ OOP éšå¤„å¯è§ï¼Œè€ŒæŠ½è±¡ç±»å’Œæ¥å£åˆ™ä¸€é›†ä¸­ä½“ç°çš„ä¸¤ä¸ªå…¸å‹ã€‚

ç»§æ‰¿è¿‡åï¼Œå­ç±»å˜å¾—è¶Šæ¥è¶Šå…·ä½“ï¼Œçˆ¶ç±»åˆ™æ›´ä¸€èˆ¬ï¼Œæ›´é€šç”¨ã€‚æœ‰æ—¶å°†çˆ¶ç±»è®¾è®¡å¾—éå¸¸æŠ½è±¡ï¼Œä»¥è‡³äºå®ƒæ²¡æœ‰å…·ä½“çš„å®ä¾‹ï¼Œè¿™æ ·çš„ç±»å«åšæŠ½è±¡ç±»ã€‚

æŠ½è±¡ç±»ï¼šï¼ˆå¯ä»¥å®šä¹‰å’Œæ™®é€šç±»å®Œå…¨ä¸€æ ·çš„å†…å®¹ï¼‰

- â— è¯­æ³•ï¼š`privilege abstract class name { }`
- â— ä¸èƒ½è¢«å®ä¾‹åŒ–ï¼Œç”¨æ¥è¢«ç»§æ‰¿ã€‚å­ç±»å¿…é¡»é‡å†™çˆ¶ç±»çš„æŠ½è±¡æ–¹æ³•ï¼Œæ‰èƒ½è¢«å®ä¾‹åŒ–
- â— æœ‰æ„é€ å™¨(æ‰€ä»¥çš„ç±»éƒ½æœ‰æ„é€ å™¨)
- â— æŠ½è±¡ç±»ä¸­ä¸ä¸€å®šæœ‰æŠ½è±¡æ–¹æ³•

æŠ½è±¡æ–¹æ³•ï¼šï¼ˆåªæœ‰æ–¹æ³•çš„å£°æ˜ï¼Œæ²¡æœ‰æ–¹æ³•çš„å®ç°ã€‚åœ¨å®šä¹‰æŠ½è±¡æ–¹æ³•æ—¶æ²¡æœ‰æ–¹æ³•ä½“å’Œ { }ï¼Œç»“å°¾åˆ†å·ç»“æŸï¼‰

- â— è¯­æ³•ï¼š`privilege abstract void/type name(arguments);`
- â— æŠ½è±¡æ–¹æ³•æ‰€åœ¨çš„ç±»ä¸€å®šæ˜¯æŠ½è±¡ç±» 
- â— å­ç±»å¦‚æœç»§æ‰¿çš„æ˜¯æŠ½è±¡çš„çˆ¶ç±»ï¼ˆæœ‰æŠ½è±¡æ–¹æ³•ï¼‰ï¼Œé‚£ä¹ˆå­ç±»å¿…é¡»é‡å†™çˆ¶ç±»çš„æ‰€æœ‰æŠ½è±¡æ–¹æ³•æˆ–è€…å­ç±»ä¹Ÿæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»
- â— è‹¥å­ç±»ç»§æ‰¿æŠ½è±¡ç±»ï¼Œå¹¶é‡å†™æ‰€æœ‰çš„æŠ½è±¡æ–¹æ³•ï¼Œåˆ™æ­¤ç±»æ˜¯ä¸€ä¸ªâ€œå®ä½“ç±»â€ï¼Œå³å¯ä»¥å®ä¾‹åŒ–

æ¥å£ï¼šinterface æ˜¯ä¸€ç§ç‰¹æ®Šçš„æŠ½è±¡ç±»ï¼Œæ˜¯æŠ½è±¡æ–¹æ³•å’Œå¸¸é‡å€¼å®šä¹‰çš„é›†åˆï¼Œæ²¡æœ‰å…·ä½“çš„å®ç°ã€‚

- â— æ¥å£ç±»è¯­æ³•ï¼š`privilege interface name { }`
- â— å¸¸é‡(æˆå‘˜å˜é‡)è¯­æ³•ï¼š`public static final type NAME = value;`ï¼ˆå…¶ä¸­ public static final å¯ä»¥çœç•¥ï¼Œä¸ºé»˜è®¤ï¼‰
- â— æŠ½è±¡æ–¹æ³•è¯­æ³•ï¼š`public abstract void/type name(arguments)`ï¼ˆå…¶ä¸­ public abstract å¯ä»¥çœç•¥ï¼Œä¸ºé»˜è®¤ï¼‰
- â— å®ç°æ¥å£è¯­æ³•ï¼š`privilege class name implements interface_name { }`ï¼ˆå®ç°å¤šä¸ªæ¥å£ï¼Œæ¥å£åç§°ä¹‹é—´ä½¿ç”¨â€œï¼Œâ€åˆ†éš”ï¼‰
- â— å®ç°ç±»å¯ä»¥ç»§æ‰¿çˆ¶ç±»ä¹Ÿå¯ä»¥å®ç°æ¥å£è¯­æ³•ï¼š`privilege class Derived extends BaseClass implements interface_name { }`
- â— å¯¹è±¡çš„å¼•ç”¨è¯­æ³•ï¼š`interface_name name = new Derived()` æ¥å£ä¸å®ç°ç±»ä¹‹é—´ä¹Ÿå­˜åœ¨å¤šæ€æ€§


## âš¡ Inheritances ç»§æ‰¿

ç»§æ‰¿æ˜¯é¢å‘å¯¹è±¡ç¼–ç¨‹çš„åŸºæœ¬èƒ½åŠ›ä¹‹ä¸€ï¼Œé€šè¿‡ç»§æ‰¿ï¼Œå¯ä»¥ç›´æ¥å¤ç”¨ç°æœ‰ä»£ç ã€‚C++ çš„åŸºæœ¬ç»§æ‰¿æ–¹å¼æœ‰å•ç»§æ‰¿ã€å¤šç»§æ‰¿ã€è™šç»§æ‰¿ï¼Œæ¶‰åŠå†…å­˜å¸ƒå±€çš„ Polymorphism å¤šæ€ç‰¹æ€§ã€‚

å‡ ä¹ä¸ä½¿ç”¨ protected æˆ– private ç»§æ‰¿ï¼Œé€šå¸¸ä½¿ç”¨ public ç»§æ‰¿ï¼Œç»§æ‰¿æƒé™ä¿®é¥°éµå¾ªä»¥ä¸‹å‡ ä¸ªè§„åˆ™ï¼š

- å…¬æœ‰ç»§æ‰¿ Public ä¿æŒåŸºç±»åŸæœ‰çš„è®¿é—®æƒé™ï¼›
- ä¿æŠ¤ç»§æ‰¿ Protected åˆ™å°†åŸºç±»çš„å…¬æœ‰æƒé™é™çº§ä¸ºä¿æŠ¤ï¼›
- ç§æœ‰ç»§æ‰¿ Private åˆ™å°†åŸºç±»çš„æ‰€æœ‰æƒé™é™çº§ä¸ºç§æœ‰ï¼›

æ‰€è°“å±€éƒ¨ç±» local class å°±æ˜¯å®šä¹‰åœ¨ä¸€ä¸ªå‡½æ•°å†…éƒ¨çš„ç±»ï¼Œè¿™ä¸ªç±»åªèƒ½åœ¨è¿™ä¸ªå‡½æ•°å†…éƒ¨ä½¿ç”¨ï¼Œä¾‹å­ï¼š

```cpp
int main()
{
    class c4
    {
    public:
        int a;
        void foo() {a = 4;}
    };
 
    class c4 ff;
    ff.foo();
    cout << ff.a << endl;
    return 0;
}
```

æ‰€è°“åµŒå¥—ç±»ï¼Œå³åœ¨ç±»å†…éƒ¨å®šä¹‰çš„ç±»ï¼Œæ ¹æ®ç±»çš„è®¿é—®ä¿®é¥°ç¬¦å†³å®šå¤–éƒ¨ä»£ç æ˜¯å¦å¯ä»¥è®¿é—®ï¼š

```cpp
#include <cstdio>
#include <typeinfo>

class Base
{
    class _neasted
    {
        const char *data = "some secret";
    public:
        void test()
        { 
            printf("%s\n", typeid(*this).name()); 
        };
    };

public:
    Base()
    {
        _neasted _n;
        neasted n;
        printf("Construct %s\n", typeid(*this).name());
        // error: 'char Base::_neasted::data []' is private within this context
        // printf("--> Test _neasted: %s\n", _n.data);
        printf("--> Test neasted: %s\n", n.data);
    }

    ~Base()
    {
        printf("Destructure of %s\n", __FUNCTION__);
    }
    
    class neasted
    {
    public:
        const char *data = "some string";
        void test()
        { 
            printf("%s\n", typeid(*this).name()); 
        }
    };
};


int main()
{
    Base();

    // error: 'class Base::_neasted' is private within this context
    // Base::_neasted _n;
    Base::neasted n;
    printf("%s:\n", __FUNCTION__);
    printf("--> Test neasted: %s\n", n.data);

    return 0;
}
```


## âš¡ Friend & Access Control

C++ ä½¿ç”¨ public protected private ä¸‰çº§è®¿é—®æ§åˆ¶æƒï¼Œç»“æ„ä½“é»˜è®¤ public è®¿é—®æƒï¼Œç±»é»˜è®¤ private è®¿é—®æƒã€‚

```C++
#include <iostream>

using namespace std;

class Base
{
private:
    int nPrivate;
public:
    int nPublic;
protected:
    int nProtected;
};

class Derived: public Base // public ç»§æ‰¿
{
    void AccessTest()
    {
        nPublic = 1;    // Ok å¯ä»¥è®¿é—® public ç»§æ‰¿çš„åŸºç±» protected æˆå‘˜
        nProtected = 1; // Ok å¯ä»¥è®¿é—® public ç»§æ‰¿çš„åŸºç±» protected æˆå‘˜
        //nPrivate = 1; // No ä¸èƒ½è®¿é—® public ç»§æ‰¿çš„åŸºç±» private æˆå‘˜
        Derived d;
        // d.nProtected = 1; // Ok å¯ä»¥ä»å¤–éƒ¨è®¿é—® public æˆå‘˜
        // d.nProtected = 1; // No ä¸èƒ½ä»å¤–éƒ¨è®¿é—® protected æˆå‘˜
        // d.nPrivate = 1;   // No ä¸èƒ½ä»å¤–éƒ¨è®¿é—® private æˆå‘˜
    }
};

int main()
{
    Derived s;
    s.AccessTest();
    return 0;
}
```

Table 14.1 Varieties of Inheritance å±•ç¤ºäº†å„ç§åŸºæœ¬ç»§æ‰¿å…³ç³»ä¸­çˆ¶ç±»æˆå‘˜åœ¨å­ç±»ä¸­çš„è®¿é—®æƒï¼š

|  Base's Property   | Public Inheritance | Protected Inheritance | Private Inheritance |
|--------------------|--------------------|-----------------------|---------------------|
| Public members     | Public members     | Protected members     | Private members     |
| Protected members  | Protected members  | Protected members     | Private members     |
| Private members    | NO                 | NO                    | NO                  |
| Implicit upcasting | Yes                | Yes (within)          | No                  |

æ³¨æ„ï¼Œpublic ç»§æ‰¿æ–¹å¼æ˜¯å®Œå…¨æ”¯æŒéšå¼è½¬å‹çš„ï¼Œå³ç¼–è¯‘å™¨ä¼šç›´æ¥å°†å­ç±»å®ä¾‹å˜é‡æˆ–æŒ‡é’ˆèµ‹å€¼ç»™çˆ¶ç±»å®ä¾‹å˜é‡æˆ–æŒ‡é’ˆã€‚

å‹å…ƒæœºåˆ¶å…è®¸ä¸€ä¸ªç±»å‘å¦ä¸€ä¸ªç±»å…¬å¼€å…¶æ‰€æœ‰æˆå‘˜è®¿é—®æƒçš„ï¼Œè®¿é—®æƒå¯ä»¥æˆäºˆæŒ‡å®šçš„å‡½æ•°æˆ–è€…ç±»åŠç±»æˆå‘˜æ–¹æ³•ã€‚

å‹å…ƒçš„å£°æ˜åªèƒ½å‡ºç°åœ¨ç±»å£°æ˜å†…ï¼Œé€šå¸¸ï¼Œå°†å‹å…ƒå£°æ˜æˆç»„åœ°æ”¾åœ¨ç±»å®šä¹‰çš„å¼€å§‹æˆ–ç»“å°¾æ˜¯ä¸ªå¥½ä¸»æ„ã€‚å£°æ˜å‹å…ƒåï¼Œå°±è¡¨ç¤ºä¿¡ä»»å‹å…ƒå¯¹è‡ªèº«çš„ç§å¯†æ•°æ®æˆ–æˆå‘˜è¿›è¡Œè®¿é—®ï¼š

```cpp
class MyFiends {
    friend void set_show(int x, A &a);
    friend void B::set_show(int x, A &a);
    friend class C;
    friend int main();
private:
    int something_for_my_friend;
}
```

å‹å…ƒå…³ç³»ä¸å¯ç»§æ‰¿ã€ä¸å¯ä¼ é€’ã€ä¸å¯äº¤æ¢ï¼Œæ„é€ å‡½æ•°ä¸èƒ½ä½œä¸ºå‹å…ƒï¼Œå‹å‹ä¸åˆ† public/proteced/privateã€‚ä½†æ˜¯ä¸ºäº†æ–¹ä¾¿æ–‡æ¡£çš„æ„å»ºï¼Œé€šå¸¸åº”è¯¥åœ¨ public ä¸‹å£°æ˜ï¼Œå› ä¸ºæ–‡æ¡£æ„å»ºæ—¶å¯èƒ½å¿½ç•¥ä¿æŠ¤ã€ç§æœ‰çš„æˆå‘˜ã€‚

ä¾‹å¦‚ï¼Œä¸å¯ä¼ é€’ï¼š

- A ç±»å£°æ˜ B ä¸ºå‹å…ƒï¼Œé‚£ä¹ˆåªèƒ½ä¿è¯ B ç±»å¯ä»¥è®¿é—® A ç±»çš„æ‰€æœ‰æˆå‘˜ã€‚
- B ç±»å£°æ˜ C ä¸ºå‹å…ƒï¼Œä¹Ÿå°±åªèƒ½ä¿è¯ C ç±»å¯ä»¥è®¿é—® B ç±»çš„æ‰€æœ‰æˆå‘˜ã€‚
- C ç±»ä¸æ˜¯ A ç±»çš„å‹å…ƒï¼Œæ‰€ä»¥ä¸å¯ä»¥è®¿é—® A ç±»çš„éå…¬æœ‰æˆå‘˜ã€‚

ç±»ã€æˆå‘˜ã€å‡½æ•°å‹å…ƒç”¨æ³•ç¤ºèŒƒï¼š

```cpp
#include <iostream>
#include <string>

using namespace std;

// Declarations
class House;
class Jack;
class Grace
{
public:
    void tryAccess(House h);
};


// Implementations
class House 
{
    friend class Jack;
    friend void Funky(House);
    friend void Grace::tryAccess(House);
public:
    string outdoor = "outside of the House.";
protected: 
    // accessible for friend
    string indoor = "inside of the House.";
private:
    // accessible for friend
    string bedroom = "inside of the Bedroom!";
};

class Jack
{
public:
    Jack(House h)
    {
        cout << "Jack is " << h.outdoor << "\n";
        cout << "Jack is " << h.indoor << "\n";
        cout << "Jack is " << h.bedroom << "\n";
    }
};

class Son: public Jack 
{
    Son(House h): Jack(h)
    {
        cout << "Jack's son is " << h.outdoor << "\n";
        // unaccessable
        // cout << "Jack's son is " << h.indoor << "\n";
        // cout << "Jack's son is " << h.bedroom << "\n";
    }
};

void Grace::tryAccess(House h)
{
    cout << "Grace is " << h.outdoor << "\n";
    cout << "Grace is " << h.indoor << "\n";
    cout << "Grace is " << h.bedroom << "\n";
}

void Funky(House h)
{
    cout << "Funky is " << h.outdoor << "\n";
    cout << "Funky is " << h.indoor << "\n";
    cout << "Funky is " << h.bedroom << "\n";
}

int main(void)
{
    House h;
    Jack j(h);
    Grace g;
    g.tryAccess(h);
    Funky(h);
    return EXIT_SUCCESS;
}
```

ä¸‹é¢ä»£ç ä¸­ï¼ŒåŸºç±» B å®šä¹‰äº†ä¸‰ç§è®¿é—®æƒé™çš„æˆå‘˜æ–¹æ³•ï¼Œåœ¨ B åœ¨ä¸­ä»»ä¸€ä¸ªæ–¹æ³•ä¸­éƒ½å¯ä»¥è°ƒç”¨ appleã€pieã€pine ä¸‰ä¸ªæˆå‘˜æ–¹æ³•ã€‚è€Œ Xã€Yã€Z åˆ†åˆ«ä»¥ä¸‰ç§é™ç»§æ‰¿ Bï¼ŒXã€Yã€Z ç±»çš„ç»§æ‰¿æ–¹æ³•ä¸åŒï¼Œä½¿å¾—å®ƒä»¬çš„å­ç±»å¯¹åŸºç±» B çš„æˆå‘˜æ–¹æ³•æœ‰ä¸åŒçš„è®¿é—®æƒé™ï¼Œä½†åœ¨ Xã€Yã€Z å†…ä¸å¯è®¿é—®çš„æ–¹æ³•åªæœ‰ pine è¿™ä¸ªç§æœ‰æ–¹æ³•ã€‚N ç±»ç»§æ‰¿äº† Z ç±»ï¼Œç”±äº Z ç±»çš„ç§æœ‰ç»§æ‰¿ä½¿å¾— N ç±»å¯¹åŸºç±» B çš„æ‰€æœ‰æˆå‘˜éƒ½ä¸å…·æœ‰è®¿é—®æƒé™ã€‚

åœ¨ç±»å¤–éƒ¨ç¯å¢ƒä¸­ï¼Œå³ main å‡½æ•°ä¸­åªæœ‰ B ç±»åŠå­ç±» X å¯ä»¥è®¿é—® apple() æ–¹æ³•ã€‚C++ ä¸­æ²¡æœ‰ super æˆ– parent ç­‰å…³é”®å­—ï¼Œæƒ³è¦è°ƒçˆ¶ç±»æ–¹æ³•ï¼Œåªèƒ½ä»¥ä¸¤ä¸ªå†’å·æŒ‡å®šçˆ¶ç±»åç§°åŠæ–¹æ³•å B::apple() è¿™ç§æ–¹å¼è°ƒç”¨ã€‚

```cpp
#include <iostream>

class B {
    // å…¬æœ‰æˆå‘˜æ–¹æ³•å…è®¸å­ç±»è®¿é—®
    public: void apple() {
        std::cout << "B::apple() is called" << std::endl; 
    }

    // ä¿æŠ¤æˆå‘˜æ–¹æ³•ä¸å…è®¸ç§æœ‰ç»§æ‰¿çš„å­ç±»è®¿é—®
    protected: void pie() {
        std::cout << "B::pie() is called" << std::endl; 
    }

    // ç§æœ‰æˆå‘˜æ–¹æ³•åªå…è®¸å‹å…ƒå­ç±»è®¿é—®
    private: void pine() {
        std::cout << "B::pine() is called" << std::endl; 
    }

    friend class F; // å‹å…ƒç±»å£°æ˜
};

class X: public    B { 
    /* å…¬æœ‰ç»§æ‰¿ä¸å¯è®¿é—®åŸºç±»ç§æœ‰æ–¹æ³• pine() */ 
};

class Y: protected B { 
    /* ä¿æŠ¤ç»§æ‰¿ï¼ŒåŸºç±»å…¬æœ‰æˆå‘˜å°†é™çº§ä¸ºä¿æŠ¤æˆå‘˜ï¼Œä¸å¯è®¿é—®åŸºç±»ç§æœ‰æ–¹æ³• pine() */ 
};

class Z: private   B { 
    /* ç§æœ‰ç»§æ‰¿å°†éšè—åŸºç±»ï¼Œä¸æš´éœ²ç»™ä¸‹ä¸€çº§ä»£ç  */ 
    // public: Z(){ B::pie(); }
};

class N: public Z { 
    // ä¸å¯è®¿é—®ç§æœ‰ç»§æ‰¿çš„åŸºç±» apple() pie() pine() 
    // public: N(){ B::apple(); }
};

class F: private B { 
    // å‹å…ƒç±»å¯è®¿é—®åŸºç±»ç§æœ‰æ–¹æ³•
    public: F(){ B::pine(); }
};

int main()
{
    X x; Y y; Z z; N n; F f;
    x.apple();
    // x.pie();   // ä¸å¯å¤–éƒ¨è®¿é—®ä¿æŠ¤æˆå‘˜
    // y.apple(); // ä¸å¯è®¿é—®ä¿æŠ¤ç»§æ‰¿çš„åŸºç±»
    // z.apple(); // ä¸å¯è®¿é—®ç§æœ‰ç»§æ‰¿çš„åŸºç±»
}
```

ä¸Šé¢è¿˜å°† F ç±»ä½œä¸ºå‹å…ƒå¼•å…¥åˆ° A ç±»ä¸­ï¼Œè¿™æ ·åœ¨ F ç±»ä¸­å¯ä»¥è®¿é—® A ç±»çš„ä»»æ„æˆå‘˜ï¼Œå°±åƒæ˜¯è‡ªå·±çš„å®¶ä¸€æ ·ï¼Œè¿˜å¯ä»¥å°† main å‡½æ•°ä½œä¸ºå‹å…ƒå¼•å…¥ A ç±»ï¼Œè¿™æ ·åœ¨ main æ–¹æ³•ä¸­ä¹Ÿåƒåœ¨ A ç±»å†…ä¸€æ ·è®¿é—®å…¶ç§æœ‰æˆå‘˜ã€‚


## âš¡ Override vs. Overwrite

C++ ä¸­æœ‰å‡ ä¸ªå¸¸è®©åˆå­¦è€…æä¸æ¸…æ™°çš„æœ¯è¯­ï¼Œé€šè¿‡è™šå‡½æ•°è¡¨çš„è§£æå°±ååˆ†æ˜ç¡®ï¼š

- Overload é‡è½½ï¼Œæ˜¯æŒ‡åœ¨*åŒä½œç”¨åŸŸ*å®šä¹‰*åŒå*ï¼Œä½†*ç­¾åä¸åŒ*çš„å‡½æ•°ï¼Œç­¾ååŒ…æ‹¬äº†å‚æ•°ç±»å‹ã€å‚æ•°é¡ºåºï¼Œæ˜¯å¦æœ‰ const å’Œ volatile å…³é”®å­—ã€‚
- Override è¦†ç›–ï¼Œæ˜¯æŒ‡åœ¨*ä¸åŒä½œç”¨åŸŸ*å³åœ¨å­ç±»ä¸­å®šä¹‰å’ŒåŸºç±»*åŒå*è€Œä¸”*åŒå‚æ•°*ã€*åŒè¿”å›å€¼*çš„å‡½æ•°ï¼Œä»¥è¦†ç›–*åŸºç±»è™šå‡½æ•°*ï¼Œä¸è™šå‡½æ•°è¡¨å…³è”ã€‚
- Overwrite é‡å†™ï¼Œä¹Ÿå«é‡å®šä¹‰ï¼Œæ˜¯æŒ‡åœ¨*ä¸åŒä½œç”¨åŸŸ*å®šä¹‰å’ŒåŸºç±»*åŒå*çš„å‡½æ•°ï¼Œä»¥å®ç°åœ¨ä½œç”¨åŸŸä¸Šå±è”½åŒåå‡½æ•°ã€‚

æ³¨æ„ï¼Œç­¾ååŒ…æ‹¬å‡½æ•°åç§°ã€å‚æ•°ç±»å‹åŠé¡ºåºï¼Œåç¼€å…³é”®å­—å¦‚ const å’Œ volatileï¼Œä½†æ˜¯ä¸åŒ…æ‹¬è¿”å›å€¼ï¼é‡è½½è§£æä¸­ä¸è€ƒè™‘è¿”å›ç±»å‹ï¼Œè€Œä¸”åœ¨ä¸åŒçš„ä½œç”¨åŸŸé‡Œå£°æ˜çš„å‡½æ•°ä¹Ÿä¸ç®—æ˜¯é‡è½½ã€‚

è™½ç„¶ï¼Œå‡½æ•°è¿”å›å€¼ä¸ä½œä¸ºç­¾åä¾›ç¼–è¯‘å™¨å‚è€ƒï¼Œä½†æ˜¯ï¼Œå¯ä»¥åœ¨å‡½æ•°å‚æ•°åˆ—è¡¨åé¢ï¼Œå³åœ†æ‹¬å·åä½¿ç”¨ç‰¹æ®Šå…³é”®æ¥ä¸ºç¼–è¯‘å™¨æä¾›é¢å¤–å‚è€ƒï¼Œä¾‹å¦‚ä½¿ç”¨ const è¡¨ç¤º non-mutable æˆå‘˜å‡½æ•°æˆ–å«åšå¸¸æˆå‘˜å‡½æ•°ï¼Œå¦åˆ™å°±æ˜¯ mutable å‡½æ•°ã€‚å¸¸æˆå‘˜å‡½æ•°ä¸æ”¹å˜å¯¹è±¡çš„æˆå‘˜å˜é‡. ä¹Ÿä¸èƒ½è°ƒç”¨ç±»ä¸­ä»»ä½•é const æˆå‘˜å‡½æ•°ã€‚å¯¹äº const ç±»å¯¹è±¡/æŒ‡é’ˆ/å¼•ç”¨ï¼Œä¹Ÿåªèƒ½è°ƒç”¨ç±»çš„ const æˆå‘˜å‡½æ•°ã€‚

å…¶ä¸­ï¼Œ*Override* åŸæ„æ˜¯æ¨ç¿»é‡æ¥ï¼Œå®Œå…¨æ»¡è¶³è™šå‡½æ•°ç­¾åæ¡ä»¶æ—¶ï¼Œä¼šå°†å‡½æ•°åœ°å€å†™å…¥çˆ¶ç±»å¯¹åº”çš„è™šå‡½æ•°è¡¨ä¸­ï¼Œå¹¶è¦†ç›–åŸå§‹è®°å½•ï¼Œè¿™å°±è¡¨ç¤ºåŸºç±»çš„ç›¸åº”è™šå‡½æ•°ç‰ˆæœ¬å·²ç»ä»å†…å­˜ä¸­æ¶ˆå¤±äº†ã€‚é™æ€æ–¹æ³•ä¸èƒ½è¢«é‡å†™ï¼Œå› ä¸º static ä¸ virtual ä¸èƒ½åŒæ—¶ä½¿ç”¨ã€‚å­ç±»å£°æ˜é‡å†™çš„å‡½æ•°æ—¶ï¼Œvirtual å…³é”®å­—çœç•¥ï¼Œæœ¬è´¨ä¸Šéƒ½æ˜¯è™šå‡½æ•°å±æ€§ã€‚

å¦‚æœç­¾åä¸€è‡³ï¼Œä½†è¿”å›å€¼ä¸ä¸€è‡´ï¼Œåˆ™ä¸èƒ½é€šè¿‡ç¼–è¯‘ï¼šé‡å†™è™šå‡½æ•°è¿”å›ç±»å‹æœ‰å·®å¼‚ï¼Œä¸”ä¸æ˜¯æ¥è‡ªåŸºç±»çš„åå˜ç±»å‹ã€‚æ‰€è°“åå˜ Covariantï¼ŒåŸæ„æ˜¯ä»¥ä¿æŒæŒ‡å®šå…³ç³»ä¸å˜çš„æ–¹å¼éšå¦ä¸€å˜é‡å˜åŒ–çš„ç»Ÿè®¡æ•°æ®ï¼ŒYou jump and I jumpï¼

é‡è½½çš„è™šå‡½æ•°åœ¨å†…å­˜æ•°æ®å¸ƒå±€ï¼Œåœ¨æ‰“å°å‡ºç°æ¥çš„è™šå‡½æ•°è¡¨ä¸­å‡ºç°çš„é¡ºåºå’Œå£°æ˜é¡ºåºæ˜¯ç›¸åçš„ã€‚

æ³¨æ„ï¼ŒåŒºåˆ« *Override* ä¸ *Overwrite* çš„ä¸åŒåœ¨äºï¼Œå‰è€…æ˜¯åè€…çš„ä¸€ç§ç‰¹ä¾‹ï¼Œè€Œä¸”åªå¯¹è™šå‡½æ•°æœ‰æ„ä¹‰ã€‚å‰è€…åªä¼šæ¡ä»¶å®Œå…¨æ»¡è¶³çš„å‰æä¸‹ä¿®æ”¹è™šå‡½æ•°è¡¨ä¸­çš„å¯¹åº”è®°å½•ï¼Œä»å†…å­˜ä¸­æŠ¹å»è¢«è¦†ç›–çš„è™šå‡½æ•°ï¼Œå¹¶ä¸”å…¶å®ƒé‡è½½æ–¹å¼ä¹Ÿè¢«éšè—ã€‚è€Œåè€…ï¼Œåˆ™åªæ˜¯ç”¨åœ¨åŒåä¸åŒç­¾åçš„æ¡ä»¶ä¸‹ï¼Œå°†åŸºç±»çš„æ‰€æœ‰åŒåæ–¹æ³•éšè—ï¼Œä¸èƒ½ç›´æ¥è°ƒç”¨ï¼Œåªèƒ½é€šè¿‡ Scope operator :: æˆ– using declarations æ¥é—´æ¥è°ƒç”¨ã€‚

C++11 è§„èŒƒå¼•å…¥äº† *override* å’Œ *final* å…³é”®å­—ï¼Œä¸»è¦ä½œç”¨æ˜¯æç¤ºï¼Œåœ¨æˆ‘ä»¬ä¸‹é¢çš„ä»£ç ä¸­æœ‰æ²¡æœ‰å‘ç°ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿ

```cpp
class Base {
public:
    virtual void print(void){...}
};

class Derived : public Base {
public:
    void pirnt(void){...}
};
```

é¢...åŸæ¥åœ¨ Derived ä¸­å°† print è¯¯è¾“å…¥ä¸º pirntï¼Œå…³é”®é—®é¢˜æ˜¯ç¼–è¯‘å™¨å®Œå…¨å¯ä»¥æ­£ç¡®çš„ç¼–è¯‘ä¸Šé¢çš„ä»£ç ï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆéš¾å‘ç°çš„é”™è¯¯ã€‚

åœ¨å£°æ˜å‡½æ•°æ—¶ï¼Œä½¿ç”¨ *override* å…³é”®å­—å°±æ˜¯ç”¨æ¥æç¤ºç¼–è¯‘å™¨ï¼Œæ£€æŸ¥è¦†ç›–æ˜¯å¦æ­£ç¡®ï¼š

```cpp
struct A
{
    virtual void foo();
    virtual void foonal();
    void bar();
};
 
struct B : A
{
    void foo() const override; // Error: B::foo does not override A::foo
                               // (signature mismatch)
    void bar() override; // Error: A::bar is not virtual
    void foo() override; // OK: B::foo overrides A::foo
    void foonal() final; // OK: B::foonal overrides A::foonal
};

struct C : B
{
    void foonal() override; // Error: can't override a final function B::foonal 
}
```


## âš¡ Scope & Name-Hiding
- Effective C++ 3rd - Item 33: Avoid hiding inherited names.

å½“ç¼–è¯‘å™¨åœ¨ someFunc çš„ä½œç”¨åŸŸä¸­é‡åˆ°åå­— x æ—¶ï¼Œå®ƒä¼šå…ˆæ£€æŸ¥ Local Scope å±€éƒ¨ä½œç”¨åŸŸï¼Œçœ‹çœ‹æ˜¯å¦æœ‰ä»€ä¹ˆä¸œè¥¿å«è¿™ä¸ªåå­—ã€‚å› ä¸ºé‚£é‡Œæœ‰ï¼Œå®ƒä»¬å°±ä¸å†æ£€æŸ¥å…¶å®ƒä½œç”¨åŸŸã€‚

åœ¨æ­¤ä¾‹ä¸­ï¼ŒsomeFunc çš„ x ç±»å‹ä¸º doubleï¼Œè€Œ global x ç±»å‹ä¸º intï¼Œä½†è¿™ä¸è¦ç´§ã€‚C++ çš„ name-hiding è§„åˆ™ä»…ä»…æ˜¯è¦†ç›–é‚£ä¸ªåå­—ï¼Œè€Œç›¸å¯¹åº”çš„åå­—çš„ç±»å‹æ˜¯å¦ç›¸åŒæ˜¯æ— å…³ç´§è¦çš„ã€‚

åœ¨æ­¤ä¾‹ä¸­ï¼Œä¸€ä¸ªåä¸º x çš„ double è¦†ç›–äº†ä¸€ä¸ªåä¸º x çš„ intã€‚

```cpp
int x; // global variable
void someFunc()
{
    double x; // local variable
    std::cin >> x; // read a new value for local x
}
```

åŠ å…¥ç»§æ‰¿ä»¥åï¼Œåœ¨ä¸€ä¸ªæ´¾ç”Ÿç±»æˆå‘˜å‡½æ•°å†…å¼•ç”¨ä½äºåŸºç±»çš„æ•°æ®æˆ–æˆå‘˜æ—¶ï¼Œç¼–è¯‘å™¨èƒ½å¤Ÿæ‰¾åˆ°æ‰€å¼•ç”¨çš„ä¸œè¥¿æ˜¯å› ä¸ºæ´¾ç”Ÿç±»ç»§æ‰¿äº†åŸºç±»å£°æ˜çš„ä¸œè¥¿ã€‚

å®é™…ä¸­çš„è¿ä½œæ–¹æ³•æ˜¯å°†æ´¾ç”Ÿç±»çš„ä½œç”¨åŸŸåµŒå¥—åœ¨åŸºç±»ä½œç”¨åŸŸä¹‹ä¸­ã€‚

ä»¥ä¸‹ä»£ç å¯¼è‡´çš„è¡Œä¸ºä¼šä½¿æ¯ä¸€ä¸ªç¬¬ä¸€æ¬¡é‡åˆ°å®ƒçš„ C++ ç¨‹åºå‘˜åƒæƒŠã€‚åŸºäºä½œç”¨åŸŸçš„åå­—è¦†ç›–è§„åˆ™ä¸ä¼šæœ‰ä»€ä¹ˆå˜åŒ–ï¼ŒåŸºç±»ä¸­çš„æ‰€æœ‰åä¸º mf1 å’Œ mf3 çš„å‡½æ•°è¢«æ´¾ç”Ÿç±»ä¸­çš„åŒåå‡½æ•°è¦†ç›–ã€‚ä»åå­—æœç´¢çš„è§‚ç‚¹çœ‹ï¼ŒBase::mf1 å’Œ Base::mf3 ä¸å†è¢« Derived ç»§æ‰¿ï¼

å®é™…ä¸Šï¼Œå¦‚æœä½ ä½¿ç”¨äº† public inheritance ä½†æ²¡æœ‰ç»§æ‰¿å…¶å®ƒé‡è½½å‡½æ•°ï¼Œå°±è¿åäº†â€œæ´¾ç”Ÿç±» is-a åŸºç±»â€è¿™ä¸€åŸºæœ¬åŸåˆ™ã€‚

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå‡ ä¹æ€»æ˜¯è¦ç»•è¿‡ C++ å¯¹â€œé€šè¿‡ç»§æ‰¿å¾—åˆ°çš„åå­—â€çš„ç¼ºçœçš„è¦†ç›–æœºåˆ¶ã€‚é‚£å°±æ˜¯ä½¿ç”¨ Scope Operator :: ç›´æ¥æŒ‡å®šä½œç”¨åŸŸï¼Œæˆ–è€…ä½¿ç”¨ using declarations æ¥è§£å†³ã€‚

```cpp
class Base {
private:
    int x;
public:
    virtual void mf1() = 0;
    virtual void mf1(int) {};
    void mf3() {};
    void mf3(double d) {};
};
class Derived: public Base {
public:
    // using Base::mf1;       // make all things in Base named mf1 and mf3
    // using Base::mf3;       // visible (and public) in Derived's scope
    virtual void mf1() {};
    void mf3() {};
};

int main()
{
    Derived d;
    d.mf1(1);       // Error Derived::mf1() hide Base::mf1()
    d.mf3(1);       // Error Derived::mf3() hide Base::mf3()
    d.Base::mf1(2); // OK always
    d.Base::mf3(2); // OK always
}
```

è®°ä½ï¼š

- âœ¦ æ´¾ç”Ÿç±»ä¼šéšè—åŒåçš„åŸºç±»æˆå‘˜ã€æ•°æ®ç­‰ã€‚åœ¨å…¬å…±ç»§æ‰¿ä¸‹ï¼Œè¿™ä¸ä¼šæ˜¯æƒ³è¦çš„ã€‚
- âœ¦ è®©è¢«éšè—çš„åå­—å†æ¬¡å‘ˆç°ï¼Œè¯·ä½¿ç”¨ using declarations or forwarding functionsã€‚


## âš¡ CRTP Static Polymorphism é™å¤šæ€
- Cee Plus Plus Idioms http://wiki.c2.com/?CeePlusPlusIdioms
- CRTP ç¼–ç¨‹æ¨¡å¼ https://www.fluentcpp.com/2017/05/12/curiously-recurring-template-pattern/
- C++ Core Guidelines http://isocpp.github.io/CppCoreGuidelines/CppCoreGuidelines
- c++ Patterns https://cpppatterns.com
- Design Patterns in Modern C++ Reusable Approaches for Object-Oriented Software Design by Dmitri Nesteruk
- Hands-On Design Patterns With C++ by Fedor G. Pikus - CH8 The Curiously Recurring Template Pattern
- å¥‡å¼‚é€’å½’æ¨¡æ¿æ¨¡å¼(Curiously Recurring Template Pattern) https://zhuanlan.zhihu.com/p/54945314
- https://zh.cppreference.com/w/cpp/memory/enable_shared_from_this
- https://eli.thegreenplace.net/2013/12/05/the-cost-of-dynamic-virtual-calls-vs-static-crtp-dispatch-in-c

é™å¤šæ€æ˜¯ä¸€ç§æ¯” Dynamic Binding å®ç°çš„å¤šæ€æ›´æœ‰æ•ˆç‡çš„å¤šæ€å®ç°æ–¹å¼ã€‚

ä»¥ä¸‹æ˜¯ç®€å•çš„ç¤ºèŒƒï¼Œä½¿ç”¨ struct æ˜¯å› ä¸ºå®ƒé»˜è®¤çš„è®¿é—®æƒä¸º publicï¼Œæ–¹ä¾¿å†™ä»£ç ï¼Œè€Œ class é»˜è®¤è®¿é—®æƒä¸º privateã€‚

```cpp
// static polymorphism demo
template <class impl>
class base : public impl { 
public: void op() { impl::op(); }};

struct impl { void op() {  std::cout<< "work here\n"; }};

base<impl>().op();
```

è¿™æ˜¯ä¸€ç§ç¼–ç¨‹æ¨¡å¼ï¼ŒåŸºäºæ¨¡æ¿å‚æ•°ä½œä¸ºåŸºç±»çš„æ··å…¥æ¨¡å¼ Mixin Typesã€‚

å¥‡å¼‚é€’å½’æ¨¡æ¿æ¨¡å¼ CRTP - Curiously Recurring Template Patternï¼Œæ›´ä¸€èˆ¬åœ°è¢«ç§°ä½œ F-bound polymorphismã€‚

CRTP æ˜¯ C++ æ¨¡æ¿ç¼–ç¨‹æ—¶çš„ä¸€ç§æƒ¯ç”¨æ³•ï¼šæŠŠæ´¾ç”Ÿç±»ä½œä¸ºåŸºç±»çš„æ¨¡æ¿å‚æ•°ï¼Œå®ƒåœ¨ C++ ä¸­ä¸»è¦æœ‰ä¸¤ç§ç”¨é€”ï¼š

- å®ç° Static Polymorphism
- æ·»åŠ æ–¹æ³•åŒæ—¶ç²¾ç®€ä»£ç 

é€šè¿‡ CRTP å®ç°ç±»ä¼¼äºè™šå‡½æ•°çš„æ•ˆæœï¼ŒåŒæ—¶åˆæ²¡æœ‰è™šå‡½æ•°è°ƒç”¨å¼€é”€ï¼Œå› ä¸ºè™šå‡½æ•°è°ƒç”¨æ˜¯ Dynamic Bindingï¼Œéœ€è¦é€šè¿‡è™šå‡½æ•°æŒ‡é’ˆæŸ¥æ‰¾è™šå‡½æ•°è¡¨è¿›è¡Œè°ƒç”¨ã€‚åŒæ—¶ç±»çš„å¯¹è±¡çš„ä½“ç§¯ç›¸æ¯”ä½¿ç”¨è™šå‡½æ•°ä¹Ÿä¼šå‡å°‘ï¼Œå› ä¸ºä¸éœ€è¦å­˜å‚¨è™šå‡½æ•°æŒ‡é’ˆï¼Œä½†æ˜¯ç¼ºç‚¹æ˜¯æ— æ³•åŠ¨æ€ç»‘å®šã€‚

ç”¨ä»¥ä¸‹ç¤ºèŒƒä»£ç æ¼”ç¤º CRTP çš„å½¢å¼ï¼Œå…³é”®æ˜¯ä½¿ç”¨æ¨¡æ¿åŸºç±»ï¼š

```cpp
// F-bound polymorphism
template <typename Child>
struct Base
{
    void doAction()
    {
        static_cast<Child*>(this)->implementation();
    }
private:
    Base(){};
    friend Child;
};

template<typename T>
void Action(Base<T> &thing)
{
    thing.doAction();
}

struct Derived : Base<Derived>
{
    void implementation()
    {
        std::cerr << "F-bound polymorphism\n";
    }
};


int main()
{
    Derived d;
    d.doAction();
}
```

æ³¨æ„è¿™é‡Œä½¿ç”¨çš„é™æ€è½¬å‹ï¼Œå’Œå…¸å‹çš„æ´¾ç”Ÿç±»ä½¿ç”¨çš„ *dynamic_cast* ä¸åŒï¼Œå› ä¸ºè¿™é‡Œéœ€è¦çš„æ˜¯é™æ€ç»‘å®šï¼Œä½¿ç”¨ *static_cast* è½¬å‹å°±å¥½äº†ï¼Œå°†æ­¤è§†ä¸ºä¸€ç§æ„ä¹‰æš—ç¤ºã€‚

åŠ¨æ€å¼ºåˆ¶è½¬æ¢é€šå¸¸ç”¨åœ¨è¿è¡Œæ—¶ï¼Œç”¨æ¥ä¿è¯å°†æ´¾ç”Ÿç±»æ­£ç¡®è½¬å‹ã€‚ä½†åœ¨è¿™é‡Œä¸éœ€è¦è¿™ç§ä¿è¯ï¼šåŸºç±»è¢«è®¾è®¡ä¸ºé€šè¿‡å…¶æ¨¡æ¿å‚æ•°ç»§æ‰¿ï¼Œç¼–è¯‘æœŸç»‘å®šã€‚

å¦å¤–ï¼ŒåŸºç±»ä¸­å°†é»˜è®¤æ„é€ å‡½æ•°å®šä¹‰ä¸º private é˜²æ­¢å­ç±»ç»§æ‰¿æ—¶ï¼Œä¼ å…¥ä¸åˆè§„èŒƒçš„å…¶å®ƒç±»å‹ã€‚

äº‹å®ä¸Šï¼Œæ´¾ç”Ÿç±»çš„æ„é€ å‡½æ•°å¿…é¡»è°ƒç”¨åŸºç±»çš„æ„é€ å‡½æ•°ï¼Œå³ä½¿ä»£ç ä¸­æ²¡æœ‰æ˜¾å¼è°ƒç”¨å®ƒï¼Œç¼–è¯‘å™¨ä¹Ÿä¼šé»˜è®¤è¿›è¡Œè°ƒç”¨ã€‚ç”±äºåŸºç±»ä¸­çš„æ„é€ å‡½æ•°æ˜¯ç§æœ‰çš„ï¼Œé™¤äº†å‹å…ƒç±»ä¹‹å¤–ï¼Œä¸å¯èƒ½è®¿é—®å®ƒï¼Œè€Œå”¯ä¸€çš„å‹å…ƒç±»æ˜¯æ¨¡æ¿ç±»ï¼å› æ­¤ï¼Œå¦‚æœæ´¾ç”Ÿç±»ä¸æ¨¡æ¿ç±»ä¸åŒï¼Œåˆ™ä»£ç ä¸ä¼šç¼–è¯‘ï¼Œè¿™çœŸæ˜¯å¦™ç”¨ã€‚

è¿˜æœ‰ä¸€ä¸ªå®¹æ˜“å¿½ç•¥çš„é—®é¢˜ï¼Œæ´¾ç”Ÿç±»ä¸­çš„æ–¹æ³•å¯èƒ½ä¼šè¦†ç›–ç›¸åŒåç§°çš„åŸºç±»æ–¹æ³•ã€‚æ­£å¦‚ Effective C++ 3rd Item 33: Avoid hiding inherited names è§£é‡Šçš„é‚£æ ·ï¼Œå› ä¸ºè¿™äº›æ–¹æ³•ä¸æ˜¯è™šæ‹Ÿçš„ã€‚å› æ­¤ï¼Œæ‚¨éœ€è¦æ³¨æ„ï¼ŒåŸºç±»å’Œæ´¾ç”Ÿç±»ä¸­çš„åç§°ä¸èƒ½ç›¸åŒã€‚


ä¸‹é¢æ¼”ç¤ºå¦‚ä½•ç”¨å¥‡å¼‚é€’å½’æ¨¡æ¿æ¨¡å¼æ¥ç®€åŒ–æ¥å£ã€‚

å‡è®¾æœ‰ä¸€ç³»åˆ—ä¼ æ„Ÿå™¨ï¼Œæœ‰æ•°æ®çš„è¯»å†™èƒ½åŠ›ï¼Œç°åœ¨å¸Œæœ›å¢åŠ ä¸€ä¸ªæ•°æ®å¤„ç†èƒ½åŠ›ï¼Œå¯¹åŸå§‹æ•°æ®è¿›è¡Œç³»æ•°åŒ–ç¼©æ”¾ã€‚

å¦‚æœï¼ŒæŒ‰ä¼ ç»Ÿçš„ç»§æ‰¿ï¼Œæ˜¯ä¸æ˜¯è¦ç»™æ¯ä¸ªä¼ æ„Ÿå™¨éƒ½å®šä¹‰ä¸€ä¸ª scale() æ–¹æ³•ï¼Ÿæˆ–è€…å¢åŠ ä¸€å±‚ç»§æ‰¿ï¼Œå¹¶æ·»åŠ æ•°æ®å¤„ç†åŠŸèƒ½ã€‚

ä½†æ˜¯ï¼Œä½¿ç”¨ CRTP ç¼–ç¨‹æ¨¡å¼çœŸçš„ä¸è¦å¤ªæ–¹ä¾¿äº†ï¼Œç›´æ¥åœ¨æ¨¡æ¿åŸºç±»è®¾ç½®ä¸€ä¸ª scale() æ–¹æ³•å°±è§£å†³äº†ï¼Œè¿™æ“ä½œå¾ˆæœ‰å‡½æ•°å¼ç¼–ç¨‹çš„çµæ´»æ€§ã€‚ä½†æ˜¯ï¼Œè¿™ç§ç»•ä¸€åœˆè°ƒç”¨æœ¬èº«çš„æ–¹æ³•ï¼Œç¼ºç‚¹æ˜¯æ¥å£å®šä¹‰ä¸å¤Ÿç›´è§‚ã€‚

```cpp
template <typename T>
struct NumericalFunctions
{
    void scale(double multiplicator)
    {
        T& underlying = static_cast<T&>(*this);
        underlying.setValue(underlying.getValue() * multiplicator);
    }
    void square()
    {
        T& underlying = static_cast<T&>(*this);
        underlying.setValue(underlying.getValue() * underlying.getValue());
    }
    void setToOpposite()
    {
        scale(-1);
    };
};

class Sensitivity : public NumericalFunctions<Sensitivity>
{
public:
    double getValue() const { return 0; };
    void setValue(double value) { };
    // rest of the sensitivity's rich interface...
};

class Sens: public Sensitivity {};

int main()
{
    Sens st;
    st.setValue(1l);
}
```

ä¸ºä½•ä¸ç”¨éæˆå‘˜çš„æ¨¡æ¿å‡½æ•°å‘¢ï¼Ÿè¿™æ˜¯å› ä¸ºä¼šå¢åŠ é¢å¤–çš„ä»£ç ï¼Œè‡³å°‘å®ƒçš„å‚æ•°æ›´å¤šäº†ï¼Œè‡³å°‘è¦æœ‰ä¸€ä¸ªå‚æ•°ï¼Œå¦‚ä¸‹ï¼š

```cpp
template <typename T>
void scale(T& object, double multiplicator)
{
    object.setValue(object.getValue() * multiplicator);
}
```

æ ‡å‡†åº“çš„ std::enable_shared_from_this æ¨¡æ¿ç±»ä½¿ç”¨äº†ç±»ä¼¼çš„æŠ€æœ¯ã€‚

å‡å¦‚åœ¨ C++ è¦åœ¨ä¸€ä¸ªå·²è¢« shareptr ç®¡ç†çš„ç±»å‹å¯¹è±¡å†…è·å–å¹¶è¿”å› thisï¼Œä¸ºäº†é˜²æ­¢è¢«ç®¡ç†çš„å¯¹è±¡å·²è¢«æ™ºèƒ½æŒ‡é’ˆé‡Šæ”¾ï¼Œè€Œå¯¼è‡´ this æˆä¸ºæ‚¬ç©ºæŒ‡é’ˆï¼Œå¯èƒ½ä¼šè€ƒè™‘ä»¥ share_ptr çš„å½¢å¼è¿”å› this æŒ‡é’ˆã€‚

è®©éœ€è¦è¿”å› this æŒ‡é’ˆçš„ç±»ï¼Œç»§æ‰¿ std::enable_shared_from_this æ¨¡æ¿ç±»ï¼ŒåŒæ—¶æ¨¡æ¿å‚æ•°ä¸ºè¯¥ç±»çš„ç±»å‹ï¼š

```cpp
struct Good: std::enable_shared_from_this<Good>
{
    std::shared_ptr<Good> getptr() {
        return shared_from_this();
    }
};
```

å‚è€ƒ enable_shared_from_this ä»£ç ï¼š

```cpp
template<class T>
class enable_shared_from_this {
protected:
    constexpr enable_shared_from_this() { }
    enable_shared_from_this(enable_shared_from_this const&) { }
    enable_shared_from_this& operator=(enable_shared_from_this const&) {
        return *this;
    }

public:
    shared_ptr<T> shared_from_this() { return self_; }
    shared_ptr<T const> shared_from_this() const { return self_; }

private:
    weak_ptr<T> self_;

    friend shared_ptr<T>;
};
```

## âš¡ Virtual & Polymorphism è™šæ‹Ÿä¸å¤šæ€æœºåˆ¶
- Polymorphism in C++ https://www.tutorialspoint.com/cplusplus/cpp_polymorphism.htm
- Hands-On Design Patterns With C++ by Fedor G. Pikus - Chapter 1: An Introduction to Inheritance and Polymorphism

C++ è¯­è¨€ä¸­è™šå‡½æ•°ï¼ˆvirtual functionï¼‰æ˜¯åœ¨é¢å‘å¯¹è±¡ç¼–ç¨‹è¯­è¨€ä¸­çš„ä¸€ä¸ªéå¸¸é‡è¦çš„æ¦‚å¿µï¼Œè™šå‡½æ•°çš„ç›®çš„å°±åœ¨äºå®ç°å¤šæ€æ€§ã€‚

è™šå‡½æ•°çš„ä¸€ä¸ªé‡è¦ç”¨æ³•æ˜¯æœŸå¾…å­ç±»å¯¹çˆ¶ç±»çš„è™šæ‹Ÿæˆå‘˜å‡½æ•°è¿›è¡Œé‡è½½ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œ*virtual* å…³é”®å­—å°±æ„å‘³ç€â€œoverridableâ€ã€‚å½“ä½ ç”¨ä¸€ä¸ªåŸºç±»æŒ‡é’ˆæŒ‡å‘æˆ–å¼•ç”¨å®ƒçš„ç»§æ‰¿ç±»å¯¹è±¡çš„æ—¶å€™ï¼Œç”¨è¿™ä¸ªæŒ‡é’ˆæˆ–å¼•ç”¨å»è°ƒç”¨è™šå‡½æ•°æ—¶ï¼Œå®é™…è°ƒç”¨çš„æ˜¯ç»§æ‰¿ç±»çš„ç‰ˆæœ¬ã€‚

Effective C++ æåˆ°æ¡æ¬¾ 37: å†³ä¸è¦é‡æ–°å®šä¹‰ç»§æ‰¿è€Œæ¥çš„éè™šå‡½æ•°ï¼Œè¿™æ˜¯æœ‰é“ç†çš„ï¼Œç»Ÿä¸€çš„çº¦å®šè®©ä»£ç é€»è¾‘æ›´æ¸…æ™°ã€‚

å› ä¸ºé‡è½½ã€è™šæ‹Ÿã€å¤šæ€æœºåˆ¶çš„å­˜åœ¨ï¼Œç¼–è¯‘æœŸç¼–è¯‘å™¨åœ¨é€‰æ‹©è¦è°ƒç”¨çš„å‡½æ•°ç‰ˆæœ¬æ—¶æœ‰ä¸¤ç§æ–¹å¼ï¼ŒStatic & Dynamic Bindingã€‚é‚£äº›å¯ä»¥åœ¨ç¼–è¯‘æœŸç¡®å®šä¸‹æ¥çš„è°ƒç”¨ï¼Œå°±æ‰§è¡Œé™æ€ç»‘å®š Static Bindingï¼Œè¿™ç§æ–¹å¼æ•ˆç‡æ›´é«˜ï¼Œä¸å¿…åœ¨è¿è¡Œæ—¶å†é€‰æ‹©å…·ä½“è¦æ‰§è¡Œçš„å‡½æ•°ç‰ˆæœ¬ã€‚

è€Œæ‰€è°“åŠ¨æ€è”ç¼–ï¼Œæ˜¯æŒ‡åœ¨ç¨‹åºçš„è¿è¡Œé˜¶æ®µåŠ¨æ€åœ°é€‰æ‹©åˆé€‚çš„æˆå‘˜å‡½æ•°ï¼Œé‚£äº›ä¸èƒ½åœ¨ç¼–è¯‘æœŸç¡®å®šçš„è°ƒç”¨å°±éœ€è¦ä½¿ç”¨ Dynamic Bindingã€‚

å¤šæ€ Polymorphism æœ¬æ„å°±æ˜¯å¤šç§çŠ¶æ€ï¼Œå³å“ªä¸ªå‡½æ•°ç‰ˆæœ¬ä¼šè¢«è°ƒç”¨å–å†³äº Dynamic Binding ä½¿ç”¨æ–¹å¼ã€‚å½“ç„¶ï¼ŒåŠ¨æ€ç»‘å®šåªæ˜¯å…¶ä¸­ä¸€ç§å®ç°å¤šæ€çš„æ–¹æ³•ï¼Œä½¿ç”¨é™æ€ç»‘å®šä¹Ÿå¯ä»¥å®ç°å¤šæ€ã€‚

Dynamic Binding ä½¿ç”¨æ¡ä»¶ï¼š

1ï¼‰ä¸ºåŸºç±»å®šä¹‰ç±»è™šå‡½æ•°ï¼›
2ï¼‰æ´¾ç”Ÿå­ç±»å¹¶å®ç°è™šæ‹Ÿå‡½æ•°ï¼›
3ï¼‰ä½¿ç”¨åŸºç±»æŒ‡é’ˆæŒ‡å‘å­ç±»å‹çš„å¯¹è±¡ï¼Œå¹¶é€šè¿‡å®ƒè°ƒç”¨è™šå‡½æ•°ï¼›

è™šå‡½æ•°å¸¸è¯†ï¼š

1ï¼‰ä¸ºä»€ä¹ˆç±»çš„é™æ€æˆå‘˜å‡½æ•°ä¸èƒ½ä¸ºè™šå‡½æ•°ï¼Ÿ

è™šå‡½æ•°å°±æ„å‘³åŠ¨æ€ç»‘å®šï¼Œä¹Ÿå°±æ˜¯å¯ä»¥åœ¨æ´¾ç”Ÿç±»ä¸­è¦†ç›–ï¼Œè¿™ä¸é™æ€æˆå‘˜å‡½æ•°çš„å®šä¹‰ï¼ˆåœ¨å†…å­˜ä¸­åªæœ‰ä¸€ä»½æ‹·è´ï¼Œé€šè¿‡ç±»åæˆ–å¯¹è±¡å¼•ç”¨è®¿é—®é™æ€æˆå‘˜ï¼‰æœ¬èº«å°±æ˜¯ç›¸çŸ›ç›¾çš„ã€‚

2ï¼‰ä¸ºä»€ä¹ˆæ„é€ å‡½æ•°ä¸èƒ½ä¸ºè™šå‡½æ•°ï¼Ÿ

å› ä¸ºå¦‚æœæ„é€ å‡½æ•°ä¸ºè™šå‡½æ•°çš„è¯ï¼Œå®ƒå°†ä¼šåœ¨æ‰§è¡ŒæœŸé—´è¢«æ„é€ ï¼Œè€Œæ‰§è¡ŒæœŸåˆ™æ„å‘³å·²ç»å®Œæˆå¯¹è±¡æ„é€ è¿‡ç¨‹ï¼Œè¿™ä¹Ÿæ˜¯å†²çªçš„ã€‚æ„é€ å‡½æ•°æ‰€å®Œæˆçš„å·¥ä½œå°±æ˜¯ä¸ºäº†å»ºç«‹åˆé€‚çš„å¯¹è±¡ï¼Œå› æ­¤åœ¨æ²¡æœ‰æ„å»ºå¥½çš„å¯¹è±¡ä¸Šä¸å¯èƒ½æ‰§è¡Œå¤šæ€çš„å·¥ä½œã€‚åœ¨ç»§æ‰¿ä½“ç³»ä¸­ï¼Œæ„é€ çš„é¡ºåºæ˜¯å…ˆæ„é€ åŸºç±»ï¼Œå†æ„é€ æ´¾ç”Ÿç±»ï¼Œå…¶ç›®çš„å°±åœ¨äºç¡®ä¿å¯¹è±¡èƒ½å¤ŸæˆåŠŸåœ°æ„å»ºã€‚æ„é€ å‡½æ•°åŒæ—¶æ‰¿æ‹…ç€è™šå‡½æ•°è¡¨çš„å»ºç«‹ï¼Œå¦‚æœå®ƒæœ¬èº«éƒ½æ˜¯è™šå‡½æ•°çš„è¯ï¼Œå¦‚ä½•ç¡®ä¿ vtbl çš„æ„å»ºæˆåŠŸå‘¢ï¼Ÿ

3ï¼‰è™šææ„å‡½æ•°å¦‚ä½•æ‰§è¡Œï¼Ÿ

C++ å¼€å‘çš„æ—¶å€™ï¼Œç”¨æ¥åšåŸºç±»çš„ç±»çš„ææ„å‡½æ•°ä¸€èˆ¬éƒ½æ˜¯è™šå‡½æ•°ã€‚å½“åŸºç±»ä¸­æœ‰è™šå‡½æ•°çš„æ—¶å€™ï¼Œææ„å‡½æ•°ä¹Ÿè¦å®šä¹‰ä¸ºè™šææ„å‡½æ•°ã€‚å¦‚æœä¸å®šä¹‰è™šææ„å‡½æ•°ï¼Œå½“åˆ é™¤ä¸€ä¸ªæŒ‡å‘æ´¾ç”Ÿç±»å¯¹è±¡çš„æŒ‡é’ˆæ—¶ï¼Œä¼šè°ƒç”¨åŸºç±»çš„ææ„å‡½æ•°ï¼Œè€Œæ´¾ç”Ÿç±»çš„ææ„å‡½æ•°æœªè¢«è°ƒç”¨ï¼Œé€ æˆå†…å­˜æ³„éœ²ã€‚

æ³¨æ„ï¼šnew å’Œ delete æ˜¯è¡¨è¾¾å¼ï¼Œæ˜¯é™æ€çš„æˆå‘˜å‡½æ•°ï¼Œä¸èƒ½æ˜¯è™šå‡½æ•°ã€‚C++ Primer æ¼”ç¤ºäº†é€šè¿‡é‡è½½ç±»çš„ operator new, operator delete æ¥è¾¾åˆ°ç±»ä¼¼æ•ˆæœï¼Œnew Expression versus operator new Functionã€‚

åªéœ€è¦åœ¨å£°æ˜å‡½æ•°æ—¶ä½¿ç”¨ *virtual* å…³é”®å­—ï¼Œå®šä¹‰å‡½æ•°ä½“æ—¶ä¸éœ€è¦ï¼Œå­ç±»å£°æ˜ä¸­ä¹Ÿå¯ä»¥ä¸ä½¿ç”¨ã€‚

è™šå‡½æ•°æ˜¯é€šè¿‡ä¸€å¼ è™šå‡½æ•°è¡¨æ¥å®ç°çš„ï¼Œç®€ç§° V-Tableï¼Œå®ƒæ˜¯ä¸€å—è¿ç»­çš„å†…å­˜ï¼Œæ¯ä¸ªå†…å­˜å•å…ƒä¸­è®°å½•ä¸€ä¸ª JMP æŒ‡ä»¤çš„åœ°å€ã€‚ç¼–è¯‘å™¨ä¼šä¸ºæ¯ä¸ªæœ‰è™šå‡½æ•°çš„ç±»åˆ›å»ºä¸€ä¸ªè™šå‡½æ•°è¡¨ï¼Œè¯¥è™šå‡½æ•°è¡¨å°†è¢«è¯¥ç±»çš„æ‰€æœ‰å¯¹è±¡å…±äº«ï¼Œç±»çš„æ¯ä¸ªè™šå‡½æ•°æˆå‘˜å æ®è™šå‡½æ•°è¡¨ä¸­çš„ä¸€è¡Œã€‚

åœ¨è¿™ä¸ªè¡¨ä¸­ï¼Œä¸»è¦æ˜¯ä¸€ä¸ªç±»çš„è™šå‡½æ•°çš„åœ°å€è¡¨ã€‚è¿™å¼ è¡¨è§£å†³äº†ç»§æ‰¿ã€è¦†ç›–çš„é—®é¢˜ï¼Œä¿è¯å…¶çœŸå®ååº”å®é™…çš„å‡½æ•°ã€‚åœ¨æœ‰è™šå‡½æ•°çš„ç±»çš„å®ä¾‹ä¸­ï¼Œåˆ†é…äº†æŒ‡å‘è¿™ä¸ªè¡¨çš„æŒ‡é’ˆçš„å†…å­˜ã€‚æ‰€ä»¥ï¼Œå½“ç”¨çˆ¶ç±»çš„æŒ‡é’ˆæ¥æ“ä½œä¸€ä¸ªå­ç±»çš„æ—¶å€™ï¼Œè¿™å¼ è™šå‡½æ•°è¡¨å°±æŒ‡æ˜äº†å®é™…æ‰€åº”è¯¥è°ƒç”¨çš„å‡½æ•°ã€‚


è™šæ‹Ÿæœºåˆ¶çš„åŸºæœ¬ç”¨æ³•ï¼š

- è™šå‡½æ•°ï¼Œä¾‹å¦‚ï¼š`virtual void imaging() const throw();`
- çº¯è™šå‡½æ•°ï¼Œä¾‹å¦‚ï¼š`virtual void pure_virtual() const throw() = 0;`
- è™šç»§æ‰¿ï¼Œä¾‹å¦‚ï¼š`class derive : virtual public base {};`
- è™šè§£æ„å‡½æ•°ï¼Œä¾‹å¦‚ï¼š `virtual ~Shape() throw();`

ä½¿ç”¨ *virtual* å…³é”®å­—å’Œçº¯è¯´æ˜ç¬¦ *=0* å°†æ–¹æ³•å®šä¹‰ä¸ºçº¯è™šå‡½æ•°ï¼Œ*Pure Virtual Functions*ï¼Œæ„æ€æ˜¯æŒ‡è¿™ä¸ªå‡½æ•°ä¸º NULL æŒ‡é’ˆï¼Œé™¤éåœ¨ç±»ä¸­æä¾›å®ç°å®šä¹‰ã€‚æ‰€å±çš„ç±»å°†ä¼šå˜ä¸ºæŠ½è±¡ç±»ï¼Œé€šå¸¸ä½œä¸ºæ¥å£ä½¿ç”¨ï¼Œæ‰€ä»¥çº¯è™šå‡½æ•°ä¸€èˆ¬åœ¨å­ç±»ä¸­æä¾›å®ç°ï¼Œè€Œä¸æ˜¯åœ¨å…¶æœ¬èº«ï¼Œå½“ç„¶å¯ä»¥è¿™æ ·åšã€‚

çº¯è¯´æ˜ç¬¦æˆ–æŠ½è±¡é‡å†™è¯´æ˜ç¬¦åªå…è®¸åœ¨è™šå‡½æ•°ä¸Šä½¿ç”¨ï¼Œå®ƒåªèµ·å½¢å¼ä¸Šçš„ä½œç”¨ï¼Œå‘Šè¯‰ç¼–è¯‘ç³»ç»Ÿâ€œè¿™æ˜¯çº¯è™šå‡½æ•°â€ã€‚

ç±»å£°æ˜åªè¦æœ‰çº¯è™šå‡½æ•°å°±ä¼šæˆä¸ºæŠ½è±¡ç±»ï¼Œä½†æ˜¯æŠ½è±¡ç±»ä¸­é™¤äº†åŒ…å«çº¯è™šå‡½æ•°å¤–ï¼Œè¿˜å¯ä»¥æä¾›å…¶å®ƒæˆå‘˜å‡½æ•°ï¼ˆè™šå‡½æ•°æˆ–æ™®é€šå‡½æ•°ï¼‰å’Œæˆå‘˜å˜é‡ã€‚ä¾‹å¦‚ï¼Œå®šä¹‰ protected æˆå‘˜å‡½æ•°ä¸“ä¾›å­ç±»ä½¿ç”¨ã€‚

åªæœ‰ç±»ä¸­çš„è™šå‡½æ•°æ‰èƒ½è¢«å£°æ˜ä¸ºçº¯è™šå‡½æ•°ï¼Œæ™®é€šæˆå‘˜å‡½æ•°å’Œé¡¶å±‚å‡½æ•°å‡ä¸èƒ½å£°æ˜ä¸ºçº¯è™šå‡½æ•°ã€‚

åŒ…å«çº¯è™šå‡½æ•°çš„ç±»ç§°ä¸ºæŠ½è±¡ç±» *Abstract Class*ï¼Œä¹‹æ‰€ä»¥è¯´å®ƒæŠ½è±¡ï¼Œæ˜¯å› ä¸ºå®ƒæ— æ³•å®ä¾‹åŒ–ï¼Œä¹Ÿå°±æ— æ³•åˆ›å»ºå¯¹è±¡ã€‚å› ä¸ºä½œä¸ºæ¥å£ä½¿ç”¨ï¼ŒæŠ½è±¡ç±»å°±æ˜¯çˆ¶ç±»ï¼Œä¹Ÿç§°ä¸º ABC (Abstract Base Class)ã€‚

åœ¨å¤§å¤šæ•° OOP è¯­è¨€ä¸­ï¼Œéƒ½æœ‰æ¥å£çš„æ¦‚å¿µï¼Œé€šå¸¸ä¹Ÿä¼šæœ‰ç›¸åº”çš„å…³é”®å­— *interface* æ¥å®šä¹‰ä¸€ä¸ªæ¥å£ï¼Œä½¿ç”¨ *implements* å…³é”®å­—æ¥å®ç°æ¥å£ã€‚æœ¬è´¨ä¸Šï¼Œæ¥å£æ˜¯ä¸€ç§çº¦å®šè§„èŒƒï¼Œç›®å½•æ˜¯ä¸ºå­ç±»æä¾›ä¸€ä¸ªç»Ÿä¸€çš„è§„èŒƒã€‚ä»è¿™ä¸€ç‚¹æ¥è¯´ï¼Œå³ä½¿ç”¨æ²¡æœ‰ *interface* å…³é”®å­—ï¼Œä½¿ç”¨ *class* ä¹Ÿå¯ä»¥å®šä¹‰ä¸€ä¸ªå…·æœ‰å®è´¨æ„ä¹‰çš„æ¥å£ã€‚

æŸäº›ç±»ï¼Œä¸»è¦æ˜¯æ¥å£è¿™æ ·çš„ç±»ï¼Œåœ¨ç°å®è§’åº¦å’Œé€»è¾‘è§’åº¦éƒ½ä¸éœ€è¦å®ä¾‹åŒ–ï¼ˆä¸éœ€è¦åˆ›å»ºå®ƒçš„å¯¹è±¡å®ä¾‹ï¼‰ï¼Œå®ƒçš„å­˜åœ¨ç›®çš„å°±æ˜¯æä¾›ä¸€ä¸ªå½¢å¼ä¸Šçš„æ¥å£ï¼Œè®©å­ç±»æŒ‰åŒä¸€è§„èŒƒæ¥å®ç°ï¼ŒC++ æŠ½è±¡ç±»çš„ç›®çš„ä¹Ÿå°±æ˜¯æä¾›æ¥å£å®šä¹‰ã€‚

ä¸€èˆ¬ä¸Šï¼Œå¤šç»§æ‰¿æœºåˆ¶ä¼šå¸¦æ¥å¤æ‚çš„é—®é¢˜ï¼Œä¸€ä¸ªç±»ç»§æ‰¿å¤šä¸ªåŸºç±»æœ¬èº«å°±æ˜¯å¤æ‚çš„ç»“æ„ã€‚ä½†æ˜¯ä¸€ä¸ªç±»å¯ä»¥æœ‰å¤šä¸ªæ¥å£ï¼Œè¿™æ˜¯å¾ˆæ­£ç¡®çš„åšæ³•ã€‚æ¥å£ç›¸å½“äºå®šä¹‰äº†ä¸€å¥—è¡Œä¸ºï¼Œå®ç°ç›¸åº”çš„æ¥å£å°±å…·æœ‰è¿™å¥—è¡Œä¸ºè§„èŒƒçš„èƒ½åŠ›ã€‚åƒé¸µé¸Ÿå›°å±€è¿™æ ·çš„é—®é¢˜ä¹Ÿå¯ä»¥å¾ˆå¥½åœ°è§£å†³ï¼Œåƒ Golang è¯­è¨€é‚£æ ·ä½¿ç”¨æ¥å£ç»„åˆæ¥æ‰©å±•ç±»çš„èƒ½åŠ›ã€‚

ä»¥ç»§æ‰¿ä¸ºç‰¹ç‚¹çš„ OOP åªæ˜¯ç¼–ç¨‹ä¸–ç•Œçš„ä¸€ç§æŠ½è±¡æ–¹å¼ï¼Œåœ¨ Golang çš„ä¸–ç•Œé‡Œæ²¡æœ‰ç»§æ‰¿ï¼Œåªæœ‰ç»„åˆå’Œæ¥å£ï¼Œå¹¶ä¸”æ˜¯æ¾æ•£çš„æ¥å£ç»“æ„ï¼Œä¸å¼ºåˆ¶å£°æ˜å®ç°æ¥å£ã€‚

If it looks like a duck, swims like a duck, and quacks like a duck, then it probably is a duck.

ç¿»è¯‘è¿‡æ¥å°±æ˜¯ï¼šå¦‚æœæŸä¸ªä¸œè¥¿é•¿å¾—åƒé¸­å­ï¼Œåƒé¸­å­ä¸€æ ·æ¸¸æ³³ï¼Œåƒé¸­å­ä¸€æ ·å˜å˜å«ï¼Œé‚£å®ƒå°±å¯ä»¥è¢«çœ‹æˆæ˜¯ä¸€åªé¸­å­ã€‚

ç»“åˆåˆ° GO è¯­è¨€ï¼Œä¹Ÿå°±æ˜¯è¯´é‚£äº›å®ç°äº†é¸­å­æŸä¸ª interface å…¨éƒ¨æ–¹æ³•çš„ struct å¯¹è±¡å°±æ˜¯é¸­å­ã€‚

å•ä¸€ç»§æ‰¿å…³ç³»è§£å†³äº† is-a ä¹Ÿå°±æ˜¯å®šä¹‰é—®é¢˜ï¼Œå› æ­¤å¯ä»¥æŠŠå­ç±»å½“åšçˆ¶ç±»æ¥å¯¹å¾…ã€‚ä½†å¯¹äºçˆ¶ç±»ä¸åŒä½†åˆå…·æœ‰æŸäº›å…±åŒè¡Œä¸ºçš„æ•°æ®ï¼Œå•ä¸€ç»§æ‰¿å°±ä¸èƒ½è§£å†³äº†ï¼ŒC++ é‡‡å–äº†å¤šç»§æ‰¿è¿™ç§å¤æ‚çš„æ–¹å¼ã€‚ã€‚

æ‰€ä»¥ï¼Œåœ¨ C++ ç¼–ç¨‹ä¸­ï¼ŒMultiple and Virtual Inheritanceï¼ŒVirtual Functions çš„å…³ç³»å¤„ç†æ˜¯é€ƒä¸æ‰çš„ï¼Œè¿™æ˜¯é«˜çº§å†…å®¹ã€‚

ä»¥ä¸‹ä»£ç å¯ä»¥ç”¨æ¥æµ‹è¯•æ„é€ å‡½æ•°å’Œææ„çš„æ‰§è¡Œé¡ºåºï¼š

```cpp
#include <iostream>

class A { public: A(){ std::cout << "A() ";} };
class B : public A { public: B(){ std::cout << "B() ";} };
class C : public B { public: C(){ std::cout << "C() ";} };
class X { public: X(){ std::cout << "X() ";} };
class Y { public: Y(){ std::cout << "Y() ";} };
class Z : public X, public Y { public: Z(){ std::cout << "Z() ";} };
class MI : public C, public Z { public: MI(){ std::cout << "MI() ";} };
class MIV : public C, virtual public Z { public: MIV(){ std::cout << "MIV() ";} };

int main()
{
    std::cout << "\n======nonvirtual inheritence=======\n";
    MI mi;
    std::cout << "\n========virtual inheritence========\n";
    MIV miv;
}
```

Output: 

    ======nonvirtual inheritence=======
    A() B() C() X() Y() Z() MI() 
    ========virtual inheritence========
    X() Y() Z() A() B() C() MIV() 

- FAQ 20.05 What happens when a destructor is executed?
- FAQ 20.06 What is the purpose of a copy constructor?

ææ„å™¨ä¼šè‡ªåŠ¨è°ƒç”¨æ‰€æœ‰æˆå‘˜å¯¹è±¡å’Œæ‰€æœ‰ç«‹å³éè™šæ‹ŸåŸºç±»çš„ææ„å‡½æ•°ã€‚é¦–å…ˆï¼Œææ„å‡½æ•°ä½“æ‰§è¡Œï¼Œç„¶åä»¥æˆå‘˜å¯¹è±¡åœ¨ç±»ä¸»ä½“ä¸­å‡ºç°çš„ç›¸åé¡ºåºè°ƒç”¨æˆå‘˜å¯¹è±¡çš„ææ„å‡½æ•°ï¼Œç„¶åè°ƒç”¨ç«‹å³åŸºç±»çš„ææ„å‡½æ•°ï¼Œä»¥ç»§æ‰¿å®ƒä»¬æ—¶åœ¨ç±»å£°æ˜ä¸­å‡ºç°çš„åå‘é¡ºåºè¿›è¡Œã€‚

è™šæ‹ŸåŸºç±»æ˜¯ç‰¹æ®Šçš„ï¼Œå®ƒä»¬çš„ææ„å‡½æ•°åœ¨å¤§å¤šæ•°æ´¾ç”Ÿç±»çš„ææ„å‡½æ•°æœ«å°¾è°ƒç”¨ã€‚è¿™æ˜¯å› ä¸ºï¼Œè™šæ‹Ÿç»§æ‰¿æœºåˆ¶æ”¹å˜äº†åŸæœ‰çš„æ„é€ å™¨æ‰§è¡Œé¡ºåºï¼Œåœ¨ç»§æ‰¿åˆ—è¡¨ä¸­çš„åŸºç±»ä¸­ï¼ŒæŒ‰è™šåŸºç±»ä¼˜å…ˆï¼Œä»å·¦åˆ°å³ï¼Œä»é¡¶çº§åˆ°åº•å±‚çš„é¡ºåºæ‰§è¡Œã€‚æ€»ä¹‹ï¼Œvirtual ç»§æ‰¿å‡ºç°çš„ä½ç½®ï¼Œå…¶åŸºç±»å°±ä¼šä¼˜å…ˆæ‰§è¡Œæ„é€ è¿‡ç¨‹ã€‚

å¯ä»¥åœ¨ä»¥ä¸Šä»£ç çš„ MI å’Œ MIV ç»§æ‰¿åˆ—è¡¨ä¸­å·®åˆ«ï¼Œåªæ˜¯åè€…å°†ç»§æ‰¿ Z çš„æ–¹å¼æ”¹ä¸º virtual è¿›è¡Œæµ‹è¯•ã€‚

ä½¿ç”¨è™šç»§æ‰¿åï¼Œå¯¼è‡´ç¼–è¯‘å™¨é€šè¿‡ç»§æ‰¿åˆ—è¡¨å…ˆæ‰¾åˆ° Z çš„é¡¶å±‚åŸºç±»å³ X -> Y -> Z è¿™æ ·çš„ä¼˜å…ˆé¡ºåºæ‰§è¡Œæ„é€ è¿‡ç¨‹ï¼Œç„¶ååˆ° A -> B -> C ã€‚

åŸæœ¬æ˜¯ä¼˜å…ˆå¤„ç† C çš„ç»§æ‰¿é“¾ï¼Œä»å…¶é¡¶å±‚åŸºç±»å¼€å§‹ï¼ŒæŒ‰ A -> B -> C è¿™æ ·çš„é¡ºåºæ‰§è¡Œæ„é€ è¿‡ç¨‹ï¼Œç„¶åå†åˆ° X -> Y -> Zã€‚

å‚è€ƒ The C++ Programming Language 3rd/4th ä¸¤ä¸ªç‰ˆæœ¬ä¸­å…³äº Class Hierarchies çš„ä¸¤ä¸ªç¤ºèŒƒä»£ç ï¼š

```cpp
class A {                  /*no constructor*/ };
class B { public: B();     /*default constructor*/ };
class C { public: C(int) ; /*no default constructor*/ };
class D : virtual public A, virtual public B, virtual public C
{
    D() { /* ... */ } // error: no default constructor for C
    D(int i) : C(i) { /* ... */ }; // ok 
};
// The C++ Programming Language, Third Edition
// 15.2.4.1 Programming Virtual Bases [hier.vbase.prog]

struct V 
{
    V(int i); // no default constructor
};
struct A 
{
    A(); // default constructor
};
struct B : virtual V, virtual A 
{
    B() : V{1} { /* ... */ }; // default constructor ; must initialize base V
};
class C : virtual V 
{
public:
    C(int i) : V{i} { /* ... */ }; // must initialize base V
};
class D : virtual public B, virtual public C {
    // implicitly gets the virtual base V from B and C
    // implicitly gets virtual base A from B
public:
    D() { /* ... */ } // error : no default constructor for C or V
    D(int i) :C{i} { /* ... */ }; // error : no default constructor for V
    D(int i, int j) :V{i}, C{j} { /* ... */ } // OK
};
// The C++ Programming Language, Forth Edition
// 21.3.5.1 Constructing Virtual Bases
```

è¿™ä¸¤ä¸ªç¤ºèŒƒä»£ç éƒ½æ˜¯åœ¨è¯´å¤šç»§æ‰¿ä¸­çš„æ„é€ è¿‡ç¨‹é—®é¢˜ï¼Œè¦ä½¿ç”¨ä¸€ä¸ªå¤šç»§æ‰¿å±‚æ¬¡ç»“æ„æˆåŠŸæ‰§è¡Œæ„é€ ï¼Œå°±å¿…éœ€æ»¡è¶³æ‰€æœ‰åŸºç±»ç›¸åº”çš„æ„é€ å‡½æ•°è¢«æˆåŠŸæ‰§è¡Œã€‚

è€Œè¿™ä¸ªè¿‡ç¨‹ä¸­ï¼ŒC++ æ„é€ å™¨ä¼šæ‰§è¡Œä¸€äº›*é»˜è®¤æ„é€ å‡½æ•°*ï¼Œå³æ²¡æœ‰å‚æ•°çš„æ„é€ å‡½æ•°ã€‚å¦‚æœæ²¡æœ‰å®šä¹‰ä»»ä½•æ„é€ å‡½æ•°ï¼Œé‚£ä¹ˆç¼–è¯‘å™¨ä¼šéšå«æä¾›ä¸€ä¸ªï¼Œè¿™ä¸ªéšå«çš„åŠ¨ä½œå°±æ˜¯ compiler-synthesizedã€‚é™¤éä»£ç ä¸­å®šä¹‰äº†ä»»ä½•ä¸€ä¸ªæ„é€ å‡½æ•°ï¼Œæ­¤æ—¶éšå«æä¾›çš„é»˜è®¤æ„é€ å‡½æ•°å°±ä¸å­˜åœ¨äº†ã€‚

è¿™å°±æ˜¯è¯´ï¼Œåƒ struct V è¿™æ ·çš„å®šä¹‰äº†ä¸€ä¸ªå¸¦æ•´æ•°å‚æ•°çš„æ„é€ å‡½æ•°ï¼Œå°±ä¸èƒ½å¯¹å®ƒè°ƒç”¨é»˜è®¤æ„é€ å‡½æ•°ï¼Œå³éœ€è¦æ˜¾å¼æŒ‡å®šè¦æ‰§è¡Œçš„æ„é€ å‡½æ•°ã€‚

è€Œ struct A æ˜¾å¼å®šä¹‰äº†é»˜è®¤æ„é€ å‡½æ•°ï¼Œæ‰€ä»¥ç¼–è¯‘å™¨ä¼šå’Œè°ƒç”¨éšå«çš„é»˜è®¤æ„é€ å‡½æ•°ä¸€æ ·ï¼Œåœ¨éœ€è¦æ—¶è‡ªåŠ¨è°ƒç”¨å®ƒã€‚


## âš¡ Virtual and Multiple Inheritance
- C++ Primier 4th - Advanced Topics - 17.3. Multiple and Virtual Inheritance
- C++ Primer Plus 6th - 14 Reusing Code in C++ - Multiple Inheritance
- Inside the C++ Object Model By Stanley B. Lippman, May 03, 1996
- Thinking in C++ 2nd Volume 2: Standard Libraries & Advanced Topics
- The C++ Programming Language 3rd - II Abstraction Mechanisms - 15.2.4.1 Programming Virtual Bases
- The C++ Programming Language 4th - III Abstraction Mechanisms - 21.3.5.1 Constructing Virtual Bases

åœ¨æ´¾ç”Ÿç±»ç»§æ‰¿åŸºç±»æ—¶ï¼ŒåŠ ä¸Š virtual public å…³é”®è¯åˆ™ä¸ºè™šæ‹Ÿç»§æ‰¿ï¼Œæ˜¯å¤šé‡ç»§æ‰¿çš„ä¸€ç§å½¢å¼ï¼Œæ´¾ç”Ÿç±»å¤šæ¬¡å…±äº«åŒ…å«åœ¨å±‚æ¬¡ç»“æ„ä¸­çš„åŸºç±»çš„å•ä¸ªå‰¯æœ¬ã€‚

è™šç»§æ‰¿ä¸å¤šç»§æ‰¿ç¤ºèŒƒä»£ç ç‰‡æ®µï¼š

```cpp
// Virtual Inheritance
class Base {};
class Derived : virtual public Base {};
// class Derived : public virtual Base {}; 
// virtual and public can appear in either order

// Multiple Inheritance
class HumanBeing {
public:
    virtual void pure_virtual() const throw() = 0;
    virtual void Show() {}
    virtual ~HumanBeing() {}
}
class Waiter : public HummanBeing { public: void Show() {} };
class Singer : public HummanBeing { public: void Show() {} };
class SingingWaiter : public Waiter, public Singer {...};
// class SingingWaiter : public Waiter, Singer {...}; // Singer is a private base
```

æ ¹æ®ä¸Šé¢çš„ä»£ç ï¼Œå…ˆæ¥ææ¸…æ¥šä¸¤ä¸ªå®¹æ˜“æ··æ·†çš„æ¦‚å¿µï¼š

- VBC - Virtual Base Classesï¼Œæ­¤å¤„ Base å°±ç§°ä¸ºè™šåŸºç±»ï¼Œè¿™æ˜¯ç›¸å¯¹äºå­ç±» Derived æ´¾ç”Ÿæ–¹å¼è€Œè¨€çš„ï¼Œè™šåŸºç±»æœ¬èº«å¯ä»¥æ˜¯ä¸€ä¸ªæ™®é€šçš„ç±»ã€‚
- ABC - Abstract Base Classesï¼Œå½“çˆ¶ç±»ä¸­å­˜åœ¨è‡³å°‘ä¸€ä¸ªçº¯è™šå‡½æ•°æ—¶ï¼Œè¿™ä¸ªç±»å°±æ˜¯æŠ½è±¡ç±»ï¼Œå®ƒä½œä¸ºåŸºç±»ä½¿ç”¨æ—¶å°±æ˜¯ ABCã€‚

è¿™é‡Œä¸»è¦å…³æ³¨è™šç»§æ‰¿ä¸å¤šç»§æ‰¿ï¼Œç›¸å¯¹äºå•ç»§æ‰¿ï¼Œä½¿ç”¨å¤šç»§æ‰¿æ˜¯ä»¶å¤æ‚çš„äº‹ï¼Œå®ƒå¸¦æ¥ä¸¤å¤§é—®é¢˜ï¼š

- äºŒä¹‰æ€§ï¼šä¸åŒçš„çˆ¶ç±»æ‹¥æœ‰åå­—ç›¸åŒçš„æˆå‘˜æ—¶ï¼Œå¦‚ä½•å¤„ç†äºŒä¹‰æ€§ï¼ŒAmbiguous upcastingï¼Ÿ
- å¤šå‰¯æœ¬ï¼šé€šè¿‡å¤šä¸ªç›´æ¥åŸºç±»ç»§æ‰¿å…±åŒåŸºç±»çš„å¤šä¸ªå®ä¾‹ï¼Œå³å†…å­˜æœ‰å¤šä¸ª HumanBeing å‰¯æœ¬ï¼ŒDuplicate subobjects å¦‚ä½•å¤„ç†ä»¥èŠ‚çœå†…å­˜ï¼Ÿ

æ‰€ä»¥ï¼Œæœ‰äººå¼ºçƒˆåå¯¹ä½¿ç”¨å¤šç»§æ‰¿ï¼Œä½†ä¹Ÿæœ‰äººé’Ÿçˆ±æœ‰åŠ ï¼Œå½¢æˆ MI vs SI ä¸¤å¤§é˜µè¥ã€‚

åœ¨å…¸å‹çš„å¤šç»§æ‰¿è±å½¢ç»“æ„ä¸­ï¼Œå¦‚ä¸Šé¢çš„ SingingWaiterï¼Œæœ‰ä¸¤ä¸ªç›´æ¥åŸºç±»å’Œä¸€ä¸ªå…±åŒåŸºç±» HumanBeingã€‚å®ä¾‹åŒ–æ—¶ï¼ŒSingingWaiter å®ä¾‹å°±ä¼šåŒ…å«å¤šä¸ªåŸºç±»å®ä¾‹ï¼Œåœ¨è¿™é‡Œå°±æ˜¯æœ‰ä¸¤ä¸ª HumanBeingï¼Œåˆ†åˆ«ä½äº Waiter å’Œ Singer çˆ¶ç±»å†…éƒ¨ï¼Œå®ƒä»¬æœ‰ç›¸åº”çš„åœ°å€ã€‚

ä»¥ä¸‹å±•ç¤ºäº†äºŒä¹‰æ€§é—®é¢˜ï¼Œä»¥åŠæ˜¾å¼è½¬å‹å¤„ç†æ–¹å¼ï¼š

```cpp
SingingWaiter ed;
HumanBeing * ph = &ed; // error: ambiguous
ed.Show(); // error: ambigous
ed.Singer::Show(); // OK: use Singer version
ed.Waiter::Show(); // OK: use Waiter version

HumanBeing * p1 = (Waiter *) &ed; // OK: the HumanBeing in Waiter
HumanBeing * p2 = (Singer *) &ed; // OK: the HumanBeing in Singer
Waiter *pw = &ed;                 // OK: the SingingWaiter upcasting as a Waiter
Singer *ps = &ed;                 // OK: the SingingWaiter upcasting as a Singer
```

äºŒä¹‰æ€§æœ‰ä¸¤ç§åŸºæœ¬æ–¹å¼è§£å†³ï¼Œä¸€æ˜¯ä½¿ç”¨ Scope Operator :: æ¥è°ƒç”¨åŒåçš„ç»§æ‰¿æ–¹æ³•æŒ‡å®šç‰ˆæœ¬ï¼Œæˆ–ä½¿ç”¨ using declarations å¦‚ `using Singer::Show;`ã€‚å¦ä¸€ä¸ªæ–¹æ³•å°±æ˜¯ä½¿å­˜åœ¨æ­§ä¹‰çš„æˆå‘˜åªåœ¨ä¸€æ¡ç»§æ‰¿è·¯å¾„ä¸Šå‡ºç°ï¼Œè€Œæœ€æ¥è¿‘çš„ç‰ˆæœ¬å°±æ˜¯é»˜è®¤è¢«è°ƒç”¨çš„ç‰ˆæœ¬ï¼Œæ›´å¥½çš„æ–¹æ³•æ˜¯æä¾›è‡ªå·±çš„ç‰ˆæœ¬ã€‚

Table 14.1 Varieties of Inheritance å±•ç¤ºäº†å„ç§åŸºæœ¬ç»§æ‰¿å…³ç³»ä¸­çˆ¶ç±»æˆå‘˜åœ¨å­ç±»ä¸­çš„è®¿é—®æƒï¼š

|  Base's Property   | Public Inheritance | Protected Inheritance | Private Inheritance |
|--------------------|--------------------|-----------------------|---------------------|
| Public members     | Public members     | Protected members     | Private members     |
| Protected members  | Protected members  | Protected members     | Private members     |
| Private members    | NO                 | NO                    | NO                  |
| Implicit upcasting | Yes                | Yes (within)          | No                  |

æ³¨æ„ï¼Œpublic ç»§æ‰¿æ–¹å¼æ˜¯å®Œå…¨æ”¯æŒéšå¼è½¬å‹çš„ï¼Œæ‰€ä»¥ä¸Šé¢çš„ä»£ç ä¸­å¯ä»¥ç›´æ¥å°† SingingWaiter çš„æŒ‡é’ˆèµ‹å€¼ç»™ Waiter æˆ– Singer æŒ‡é’ˆã€‚

è¿™ä¹Ÿæ˜¯å¤šç»§æ‰¿é—®é¢˜çš„å…³é”®ç‚¹ä¹‹ä¸€ï¼Œç¼–è¯‘å™¨å·å·åšäº†ä¸€ä»¶äº‹æƒ…ï¼šthis æŒ‡é’ˆè°ƒæ•´ï¼

åœ¨å•ç»§æ‰¿ SI æ¨¡å‹ä¸‹ï¼Œå¯¹è±¡å†…å­˜é‡‡ç”¨é‡å çš„æ¨¡å‹ï¼ŒåŸºç±»å’Œä»»ä½•çš„æ´¾ç”Ÿç±»çš„æŒ‡é’ˆéƒ½æŒ‡å‘è¯¥å¯¹è±¡çš„é¦–åœ°å€ã€‚å› æ­¤ï¼Œè½¬å‹æ“ä½œä¸å½±å“æŒ‡é’ˆæŒ‡å‘ï¼Œè¿™äº›æŒ‡é’ˆçš„åœ°å€å€¼éƒ½ä¸€æ ·ï¼Œæ‰€æœ‰åŸºç±»éƒ½å…±äº«åŒä¸€ä¸ªé¦–åœ°å€ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨å•ç»§æ‰¿ä½“ç³»å†…ï¼Œä¸è®ºä½ ç”¨ä»€ä¹ˆæ ·çš„æ–¹å¼å¯¹å…¶ä¸­ä¸€ä¸ªæŒ‡é’ˆè¿›è¡Œ downcasting æˆ– upcastingï¼ŒæŒ‡é’ˆçš„åœ°å€å€¼éƒ½æ˜¯ä¸€æ ·çš„ã€‚

ä½†æ˜¯åœ¨ MI çš„ä¸–ç•Œé‡Œï¼Œé‡‡ç”¨çš„æ˜¯éé‡å æ¨¡å‹ã€‚

ç®€å•æ¥è¯´ï¼Œå¯¹äºå­ç±»å®ä¾‹ï¼Œå…¶åŒ…å«çš„æ¯ä¸ªåŸºç±»çš„å¯¹è±¡éƒ½æœ‰è‡ªå·±çš„é¦–åœ°å€ï¼Œåªæœ‰ç»§æ‰¿åˆ—è¡¨ä¸­ç¬¬ä¸€ä¸ªåŸºç±»å¯¹è±¡åœ°å€æ‰ä¸€æ ·ã€‚

æ‰€ä»¥ï¼Œåœ¨é¢‘ç¹çš„ this æŒ‡é’ˆè°ƒæ•´ä¸­ï¼Œthis æŒ‡é’ˆåœ°å€å˜åŒ–ä¸»è¦å‘ç”Ÿåœ¨æ´¾ç”Ÿç±»å¯¹è±¡ä¸å…¶ç»§æ‰¿åˆ—è¡¨ä¸­ç¬¬ 2 ä¸ªä»¥åŠåç»­çš„åŸºç±»å¯¹è±¡ä¹‹é—´çš„è½¬æ¢ã€‚

å‚è€ƒ 1996 å¹´å‘è¡Œçš„ Inside the C++ Object Model By Stanley B. Lippmanï¼ŒChapter 3. The Semantics of Data - 3.4. Inheritance and the Data Memberã€‚

å¦‚æœåœ¨å¤šæ¡ç»§æ‰¿è·¯å¾„ä¸Šæœ‰ä¸€ä¸ªå…¬å…±çš„åŸºç±»ï¼Œåœ¨è¿™äº›è·¯å¾„ä¸­çš„æŸå‡ æ¡æ±‡åˆå¤„ï¼Œå³è¿™ä¸ª*å…¬å…±åŸºç±»*å°±ä¼šäº§ç”Ÿå¤šä¸ªå®ä¾‹ï¼Œè‹¥åªæƒ³ä¿å­˜è¿™ä¸ªå…¬å…±åŸºç±»çš„ä¸€ä¸ªå®ä¾‹ï¼Œå°±éœ€è¦å¯¹è¿™ä¸ªå…¬å…±åŸºç±»ä½¿ç”¨*è™šç»§æ‰¿*ï¼Œå°†å…¬å…±åŸºç±»å½“ä½œè™šåŸºç±» VBC - Virtual Base Classesã€‚

åœ¨å¤šç»§æ‰¿æƒ…å†µä¸‹ï¼Œä»ä¸åŒé€”å¾„å¯ä»¥èƒ½ç»§æ‰¿å¾—åˆ°åŒåçš„æ•°æ®æˆå‘˜ï¼Œè¿™åœ¨å†…å­˜ä¸­æœ‰ä¸åŒçš„æ‹·è´ä¼šé€ æˆæ•°æ®ä¸ä¸€è‡´é—®é¢˜ã€‚C++ ä½¿ç”¨è™šæ‹Ÿç»§æ‰¿ Virtual Inheritanceï¼Œå°†å…±åŒåŸºç±»è®¾ç½®ä¸ºè™šåŸºç±»ã€‚è¿™æ—¶ä»ä¸åŒçš„è·¯å¾„ç»§æ‰¿è¿‡æ¥çš„åŒåæ•°æ®æˆå‘˜åœ¨å†…å­˜ä¸­å°±åªæœ‰ä¸€ä¸ªæ‹·è´ï¼ŒåŒä¸€ä¸ªå‡½æ•°åä¹Ÿåªæœ‰ä¸€ä¸ªæ˜ å°„ã€‚é€šè¿‡è™šåŸºç±»ç»Ÿä¸€å¤šåŸºç±»ç»§æ‰¿çš„åŒåæ•°æ®æˆå‘˜è§£å†³äº†äºŒä¹‰æ€§é—®é¢˜ï¼Œä¹ŸèŠ‚çœäº†å†…å­˜ï¼Œé¿å…äº†æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ã€‚

å¦‚æœæ˜¯è™šç»§æ‰¿ã€éè™šç»§æ‰¿æ··æ­ï¼ŒåŸºç±»æœ‰å¤šå°‘å­å¯¹è±¡ï¼Œå°±è¦æŒ‰ç»„åˆæ¥è®¡ç®—ï¼Œè™šç»§æ‰¿çš„éƒ¨åˆ†ç®—ä¸€ä¸ªï¼Œå…¶å®ƒç»§æ‰¿çš„æœ‰å‡ ä¸ªç®—å‡ ä¸ªã€‚

åŠ å…¥è™šç»§æ‰¿ï¼Œå°±éœ€è¦ä¿®æ”¹åŸæœ‰ä»£ç ï¼Œå³ä½¿ç”¨åœ¨ C++ çš„ç¼–è¯‘è§„åˆ™ä¸Šä¹Ÿåšäº†è°ƒæ•´ã€‚å¦‚æœæ˜¯åœ¨å·¥ä¸šä¸Šï¼Œè¿™æ˜¯æ½œåœ¨çš„å·¥ä½œé‡ï¼Œå’Œå›æ”¶è¿”å·¥æ“ä½œæ²¡ä»€ä¹ˆä¸åŒï¼š

```cpp
class Singer : virtual public HumanBeing {...};
class Waiter : public virtual HumanBeing {...};
class SingingWaiter: public Singer, public Waiter {...};
```

æŒ‰ä»¥ä¸Šä¿®æ”¹å£°æ˜åï¼ŒåŠ å…¥äº†è™šç»§æ‰¿ï¼Œè¿™æ ·å®ä¾‹åŒ– SingingWaiter å°±åªä¼šç»§æ‰¿åˆ°ä¸€ä¸ª HumanBeing å®ä¾‹ã€‚å…³é”®å­— virtual çš„ä½ç½®å¯å‰å¯åï¼Œå®ƒçš„ä½œç”¨å°±æ˜¯å°† C++ è±å½¢å¤šç»§æ‰¿ç»“æ„ä¸­å…±åŒåŸºç±»ä½œä¸ºå­ç±»çš„ç›´æ¥åŸºç±»ä¸€æ ·çœ‹å¾…ï¼Œå³ HumanBeing ç›¸å½“äº SingingWaiter çš„ç›´æ¥åŸºç±»ã€‚

                +============+
                | HumanBeing |
                +=====+======+
                 /   v|i    \
                /    i|n     \
    +========+ /     r|h      \ +========+
    | Waiter |+      t|e       +| Singer |
    +========+ \     u|r      / +========+
                \    a|i     /
                 \   l|t    /
               +===============+
               | SingingWaiter |
               +===============+

        C++ Diamond Inheritance Hierarchy

ä»¥ä¸Šç¤ºæ„å›¾ä¹Ÿè¯´æ˜äº†è™šç»§æ‰¿çš„å…³äºæ„é€ å™¨è§„åˆ™çš„è°ƒæ•´ä¸­ï¼Œå…·æœ‰é—´æ¥è™šæ‹ŸåŸºç±»çš„æ´¾ç”Ÿç±»åº”è¯¥è®©å…¶æ„é€ å‡½æ•°ç›´æ¥è°ƒç”¨é—´æ¥åŸºç±»æ„é€ å‡½æ•°ï¼Œè¿™å¯¹äºé—´æ¥éè™šæ‹ŸåŸºç±»æ˜¯éæ³•çš„ã€‚éè™šç»§æ‰¿ä¸­ï¼Œåªæœ‰ç›´æ¥åŸºç±»çš„æ„é€ å™¨æ‰å¯ä»¥å‡ºç°åœ¨å­ç±»æ„é€ å™¨çš„ Initialization listï¼Œä¸èƒ½æ˜¯é—´æ¥åŸºç±»çš„æ„é€ å™¨ã€‚

è¿™ä¸ªè§„åˆ™çš„è°ƒæ•´ï¼Œæ˜¯å› ä¸ºåœ¨è™šç»§æ‰¿å…³ç³»ä¸­ï¼Œå¦‚æœ SingingWaiter ç›´æ¥åŸºç±»éƒ½åœ¨å…¶æ„é€ å™¨ä¸­çš„åˆå§‹åŒ–åˆ—è¡¨ä¸­æ‰§è¡Œè™šåŸºç±»çš„æ„é€ å™¨ï¼Œé‚£ä¹ˆä¼šå‡ºç°å¤šä¸ªè·¯å¾„é€šå‘è™šåŸºç±»çš„æ„é€ å™¨ï¼Œè¿™ä¸è™šç»§æ‰¿çš„è®¾è®¡è§„åˆ™ç›¸è¿èƒŒã€‚

```cpp
SingingWaiter(const Worker & man, int p = 0, int v = Singer::other)
: Waiter(man,p), Singer(man,v) {} // flawed

SingingWaiter(const Worker & man, int p = 0, int v = Singer::other)
: Worker(man), Waiter(man,p), Singer(man,v) {}
```

ä¸Šé¢ä»£ç çš„ç¬¬ä¸€ç§æ–¹å¼ï¼Œå¦‚æœåœ¨éè™šç»§æ‰¿æ¨¡å¼ä¸‹ï¼Œåˆå§‹åŒ–å‚æ•° man å¯ä»¥ç»ç”± SingingWaiter çš„çˆ¶ç±»ä¼ é€’åˆ°ä¸Šä¸€å±‚åŸºç±»ã€‚ä½†æ˜¯åœ¨è™šæ‰¿ç»§æ¨¡å¼ä¸‹ï¼Œè¿™ç§åšæ³•å°±è¢«ç¦æ­¢äº†ã€‚å› ä¸ºæ­¤æ—¶è™šåŸºç±»åªæœ‰ä¸€ä¸ªå¯¹è±¡ï¼Œæ‰€ä»¥éœ€è¦å…ˆå¯¹è™šåŸºç±»è¿›è¡Œæ„é€ ï¼Œè¿™å°±æ˜¯ä¸ºä½•å¯ä»¥åœ¨ SingingWaiter çš„æ„é€ å™¨ä¸­è°ƒç”¨è™šåŸºç±»çš„æ„é€ å™¨ã€‚

å¦‚æœè™šåŸºç±»ä¸åªæœ‰é»˜è®¤æ„é€ å™¨ï¼Œé‚£ä¹ˆå°±åº”è¯¥åœ¨å­ç±» SingingWaiter çš„æ„é€ å™¨ä¸­æ˜¾å¼è°ƒç”¨ï¼Œè¿™æ ·åšæ‰ä¿è¯è™šåŸºç±»åªæœ‰ä¸€ä¸ªå¯¹è±¡ã€‚

è™šæ‹ŸåŸºç±»çš„ä½¿ç”¨å¹¶æ²¡æœ‰é‚£ä¹ˆç®€å•ï¼Œä¸Šé¢çš„ç¤ºä¾‹ä½¿ç”¨é»˜è®¤æ„é€ å‡½æ•°ï¼ŒåŒ…æ‹¬éšå«ç¼–è¯‘å™¨åˆæˆçš„æˆ–æ˜¾å¼å®šä¹‰çš„ã€‚å¦‚æœè™šæ‹ŸåŸºæœ‰ä¸€ä¸ªæ„é€ å‡½æ•°ï¼Œäº‹æƒ…å°±ä¼šå˜å¾—æœ‰ç‚¹å¥‡æ€ªã€‚

éœ€è¦å¼•å…¥ä¸€ä¸ªæ–°æœ¯è¯­æ¥ç®€åŒ–ç†è§£ï¼šmost-derivedï¼Œæœ€è¿‘æ´¾ç”Ÿç±»ï¼Œé€šå¸¸æ˜¯æŒ‡æ‰€æ‰§è¡Œçš„æ„é€ å‡½æ•°æ‰€åœ¨çš„ç±»ï¼Œå®ƒçš„æ„é€ å™¨åªèƒ½æ‰§è¡Œç›´æ¥åŸºç±»çš„æ„é€ å‡½æ•°ã€‚ä½†æ˜¯ä½¿ç”¨è™šç»§æ‰¿åï¼Œè¿™ä¸ªæ¦‚å¿µä¹ŸæŒ‡å¯¹è™šåŸºç±»è¿›è¡Œåˆå§‹åŒ–çš„ç±»ã€‚å‚è€ƒå‰é¢çš„æ£±å½¢å±‚æ¬¡ç»“æ„ç¤ºæ„å›¾ï¼Œåœ¨è™šç»§æ‰¿æ–¹å¼ä¸‹ï¼Œæ— è®ºå­ç±»ç¦»è™šåŸºæ•°é—´éš”å¤šè¿œï¼Œå­ç±»éƒ½å¯ä»¥å¯¹è™šåŸºç±»è¿›è¡Œåˆå§‹åŒ–ã€‚

å‚è€ƒä»¥ä¸‹ç¤ºèŒƒä»£ç ï¼ŒVMan1 å’Œ VMan2 å¯¹ç›´æ¥åŸºç±» HumanBeing åˆå§‹åŒ–æ˜¯å¾ˆæ­£å¸¸çš„ï¼Œè€Œ MI æˆ– XMan åœ¨è™šç»§æ‰¿å½¢å¼ä¸‹ä¹Ÿå¯ä»¥å¯¹è¿œç«¯çš„è™šåŸºç±»è¿›è¡Œåˆå§‹åŒ–ï¼š

```cpp
class HumanBeing 
{
public:
    HumanBeing() {}
    HumanBeing(int) {}
    // pure virtual make it to be an abstract class
    virtual const char* vf() const = 0;
    virtual ~HumanBeing() {}
};
class VMan1 : virtual public HumanBeing 
{
public:
    VMan1() : HumanBeing(1) {}
    const char* vf() const { return "VMan1"; }
};
class VMan2 : virtual public HumanBeing 
{
public:
    VMan2() : HumanBeing(2) {}
    const char* vf() const { return "VMan2"; }
};
class MI : public VMan1, public VMan2 
{
public:
    MI() : HumanBeing(3) {}
    const char* vf() const {
        return VMan1::vf(); // MUST disambiguate
    }
};
class XMan : public MI 
{
public:
    // You must ALWAYS init the virtual base:
    XMan() : HumanBeing(4) {}
};
```

åƒä¸Šé¢è¿™æ ·çš„å¤šç»§æ‰¿ç»“æ„ä¸­ï¼ŒäºŒä¹‰æ€§é—®é¢˜å°±æ¯”è¾ƒå¤æ‚ã€‚HumanBeingã€VMan1ã€Vman2 åŒæ—¶å®šä¹‰äº† vf() å‡½æ•°ï¼Œç»§æ‰¿è€…è¦†ç›–äº†é¡¶å±‚åŸºæ•°çš„è™šå‡½æ•°ï¼Œå› ä¸ºå­ç±»ä¸­å‡ºç°äº†å’ŒåŸºç±»è™šå‡½æ•°åŒååˆåŒç­¾åçš„å½¢å¼ã€‚

ä½†æ˜¯æ¥ä¸‹æ¥ï¼ŒMI å¦‚ä½•è¦å¤šç»§æ‰¿ VMan1ã€Vman2 å°±ä¼šå‡ºç°ï¼Œä¸¤ä¸ªç›´æ¥åŸºç±»æœ‰ç›¸åŒç­¾åçš„è™šå‡½æ•°ï¼Œå¦‚æœä¸æ˜¯ä¸¤ä¸ªåŸºç±»éƒ½ä½¿ç”¨äº†è™šç»§æ‰¿ï¼ŒMI å¯ä»¥çœŸçš„ç»§æ‰¿å®ƒä»¬ï¼Œè€Œæ— éœ€è¦†ç›–è™šå‡½æ•° vf()ã€‚åœ¨ä¸¤è€…éƒ½ä½¿ç”¨è™šç»§æ‰¿æ—¶ï¼ŒMI å¦‚æœä¸è¦†ç›– vf()ï¼Œç¼–è¯‘å™¨å°±ä¸çŸ¥é“æ€ä¹ˆå¤„ç†äºŒä¹‰æ€§é—®é¢˜ã€‚

è¿™æ˜¯å› ä¸ºä» HumanBeing åˆ° MI ä¹‹é—´ï¼Œvf() å‡½æ•°æœ‰äºŒæ¡ç»§æ‰¿è·¯çº¿ï¼Œä» VMan1 æˆ–è€…ä» VMan2ï¼Œè¿™å°±å¯¼è‡´ï¼šno unique final overriderã€‚åœ¨ MSVC ä¸­çš„æç¤ºå°±æ˜¯ç›´æ¥åŸºç±»åŒåæ–¹æ³•ä¸æ˜ç¡®ç»§æ‰¿ï¼Œè¿™æ˜¯å…¸å‹çš„æ£±å½¢ç»§æ‰¿äºŒä¹‰æ€§é—®é¢˜ Diamond Problemã€‚

è‡³äºä¸ºä½•ä¸€å®šè¦ MI ç»§æ‰¿ vf() å‡½æ•°å‘¢ï¼Œä¸ç»§æ‰¿è¡Œå—ï¼Ÿä¸è¡Œï¼Œè‡³å°‘åœ¨è¿™ç§æƒ…å†µä¸‹ä¸è¡Œã€‚è¿™æ˜¯å› ä¸ºè™šç»§æ‰¿å¿…éœ€å°†è™šåŸºç±»çš„æ–¹æ³•ç»§æ‰¿ç»™å­ç±»ï¼Œå¦åˆ™å°±å¤±å»è™šç»§æ‰¿çš„è®¾è®¡æ„ä¹‰äº†ã€‚

å¦å¤–ï¼Œç»™è™šåŸºç±»è¿›è¡Œåˆå§‹åŒ–å¹¶ä¸æ˜¯ç”¨æˆ·å‹å¥½çš„ä¸€ç§æ–¹å¼ï¼Œå¯¹äºä»£ç çš„ç”¨æˆ·æ¥è¯´æ·±å…¥äº†è§£ç»§æ‰¿é“¾æ˜¯ä»¶ä¹å‘³æµªè´¹æ—¶é—´çš„äº‹ã€‚

å› æ­¤ï¼Œä½¿ç”¨é»˜è®¤å‚æ•°æ˜¯ä¸ªå¥½æ–¹æ³•ï¼š

```cpp
class HumanBeing {
public:
    // Default constructor removes responsibility:
    HumanBeing(int = 0) {}
    virtual char* vf() const = 0;
    virtual ~HumanBeing() {}
};
```

- FAQ 21.14 How can the compiler be kept from generating duplicate outlined copies of inline virtual functions?

å¦‚æœç±»å…·æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªè™šå‡½æ•°ï¼Œç»§æ‰¿çš„æˆ–åœ¨è¯¥ç±»ä¸­å£°æ˜çš„ï¼Œåˆ™è¯¥ç±»åº”è‡³å°‘å…·æœ‰ä¸€ä¸ªéå†…è”è™šæ‹Ÿå‡½æ•°ã€‚è®¸å¤šç¼–è¯‘å™¨ä½¿ç”¨ç¬¬ä¸€ä¸ªéå†…è”è™šæ‹Ÿå‡½æ•°çš„ä½ç½®æ¥ç¡®å®šæºæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶å°†åŒ…å«ç±»çš„ç¥å¥‡å†…å®¹ï¼ˆvirtual table, out-lined copies of inline virtual functionsï¼‰ã€‚å¦‚æœç±»çš„æ‰€æœ‰è™šæ‹Ÿå‡½æ•°éƒ½æ˜¯å†…è”å®šä¹‰çš„ï¼Œé‚£ä¹ˆè¿™äº›ç¼–è¯‘å™¨å¯èƒ½ä¼šåœ¨é‚£äº›åŒ…å«æ­¤ç±»å¤´æ–‡ä»¶çš„æ¯ä¸ªæºæ–‡ä»¶ä¸­æ”¾ç½®ç¥å¥‡å†…å®¹çš„é™æ€å‰¯æœ¬ã€‚

è¯·æ³¨æ„ï¼Œæ­¤å»ºè®®å¯¹ç¼–è¯‘å™¨ç›¸å½“æ•æ„Ÿã€‚ä¸€äº›ç¼–è¯‘å™¨ä¸ä¼šç”Ÿæˆç¥å¥‡å†…å®¹çš„å‰¯æœ¬ï¼Œå³ä½¿ç±»ä¸­çš„æ‰€æœ‰è™šæ‹Ÿå‡½æ•°éƒ½æ˜¯å†…è”çš„ã€‚ä½†å³ä½¿åœ¨è¿™äº›ç¼–è¯‘å™¨ä¸­ï¼Œä¹Ÿä¸éœ€è¦èŠ±è´¹å¤ªå¤šçš„æˆæœ¬ç¡®ä¿è‡³å°‘æœ‰ä¸€ä¸ªç±»çš„è™šæ‹Ÿå‡½æ•°æ˜¯éå†…è”çš„ã€‚

ç›¸æ¯”æ™®é€šå‡½æ•°ï¼Œè°ƒç”¨è™šå‡½æ•°çš„é¢å¤–å¼€é”€æ˜¯ä¸å¤§çš„ã€‚å®é™…ä¸Šï¼Œå‡ ä¹æ‰€æœ‰ç¼–è¯‘å™¨éƒ½ä»¥ç›¸åŒçš„æ–¹å¼è¿›è¡Œç¼–è¯‘ï¼Œå¹¶ä¸”å¼€é”€éå¸¸å°ã€‚å¹¶ä¸”åœ¨å‚æ•°è¶Šå¤šçš„æƒ…å†µä¸‹ï¼Œè¶Šè¶‹äºç›¸åŒï¼Œå› ä¸ºè™šå‡½æ•°çš„åŠ¨æ€ç»‘å®šæ˜¯æ’å®šçš„å¼€é”€ã€‚åœ¨æå¤§çš„å·®åˆ«æƒ…å†µä¸‹ï¼Œå¯èƒ½æœ‰ 10% - 20% çš„é¢å¤–å¼€é”€ã€‚


## âš¡ Class Layout ç±»æ•°æ®ç»“æ„å¸ƒå±€
- C++ vtables https://shaharmike.com/cpp/vtable-part1/
- Inside the C++ Object Model By Stanley B. Lippman, May 03, 1996
- the Virtual Table https://www.learncpp.com/cpp-tutorial/the-virtual-table/

ç±»æ•°æ®ç»“æ„åœ¨å†…å­˜å¸ƒå±€ä¸Šæœ‰ä¸¤ç§ç­–ç•¥ï¼Œå–å†³äºç¼–è¯‘å™¨çš„å®ç°ï¼Œå®ƒä»¬å†³å®šäº†è™šå‡½æ•°è¡¨åœ¨å†…å­˜ä¸­åœ°å€å¦‚ä½•å®‰æ’ï¼š

- Virtual Inheritance with Pointer Strategy
- Virtual Inheritance with Virtual Table Offset Strategy

æ ¹æ®ä½¿ç”¨çš„ç»§æ‰¿æœºåˆ¶ä¸åŒï¼Œç¼–è¯‘å™¨ä¸å®ç°å·®å¼‚ï¼Œç±»æ•°æ®å†…å­˜å¸ƒå±€æ˜æ˜¾æœ‰å˜åŒ–ï¼Œä¸»è¦åŒ…å«äº†ï¼š

- vftable è™šå‡½æ•°è¡¨ï¼šåŒ…å«è™šå‡½æ•°çš„åˆ—è¡¨æ•°æ®ç»“æ„ï¼›
- vbtable è™šåŸºç±»è¡¨ï¼šç»§æ‰¿é“¾ä¸Šæ‰€æœ‰è·¯å¾„ä¸Šå…±åŒçš„è™šåŸºç±»éƒ½é€šè¿‡ä¸€å¼ è¡¨ç®¡ç†ï¼›
- vfptr è™šå‡½æ•°æŒ‡é’ˆï¼šæŒ‡å‘è™šå‡½æ•°è¡¨ä¸­çš„é¦–æ¡ç›®ï¼›
- vbptr è™šåŸºç±»æŒ‡é’ˆï¼šæŒ‡å‘è™šåŸºç±»å‰¯æœ¬ï¼Œåœ¨ä½¿ç”¨è™šç»§æ‰¿æ—¶äº§ç”Ÿï¼›
- this adjustor ä¸Šä¸‹æ–‡æŒ‡é’ˆè°ƒæ•´ï¼šç»§æ‰¿ç»“æ„ä¸­ï¼Œæœ‰å„ç§ç±»å®ä¾‹å¯¹è±¡éœ€è¦ä½¿ç”¨ this æŒ‡é’ˆæ¥è®¿é—®æˆå‘˜ï¼Œæ ¹æ®è¿›è¡Œåç§»åœ°å€è°ƒæ•´ï¼›

æ˜¾ç„¶ï¼Œåˆ›å»ºç±»å®ä¾‹åï¼Œå®ƒå°±æ˜¯æŒ‰ç±»ç»“æ„å­˜æ”¾åœ¨å†…å­˜æŸä¸ªåŒºå—çš„æ•°æ®ç»“æ„ï¼Œä»»æ„å¤šçš„å®ä¾‹å°±æœ‰ä»»æ„å¤šçš„è¿™äº›æ•°æ®ç»“æ„ã€‚ä½†æ˜¯ç±»çš„ç»“æ„æ˜¯ç»Ÿä¸€çš„ï¼Œé™¤äº†å®ä¾‹çš„æ•°æ®ï¼Œåƒæˆå‘˜å‡½æ•°ã€é™æ€æˆå‘˜è¿™äº›ä¸œè¥¿éƒ½æ˜¯å…±ç”¨çš„ã€‚æ‰€ä»¥è®¾ç½®æ•°æ®ç»“æ„æ—¶ï¼Œå°±éœ€è¦ä½¿ç”¨ä¸€ä¸ª this æŒ‡é’ˆæ¥æŒ‡å‘è¿™äº›æ•°æ®ï¼Œå¹¶ä¸”åœ¨å®ä¾‹æ•°æ®æ‰€åœ¨è¦ä¿ç•™ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘ç±»çš„å…¬å…±ç»“æ„ã€‚å½“è°ƒç”¨æˆå‘˜æ—¶ï¼Œå°±æ ¹æ®æ•°æ®æ‰¾åˆ°åˆ°æˆå‘˜æ–¹æ³•çš„åœ°å€ï¼Œæˆ–è€…å¯¹äºè™šå‡½æ•°ï¼Œå°±å…ˆé€šè¿‡è™šå‡½æ•°è¡¨æŒ‡é’ˆæ¥å®šä½ã€‚æ‰€ä»¥ï¼Œè™šå‡½æ•°è¡¨æœ‰æ—¶ä¹Ÿè¢«å«ä½œ dispatch tableï¼Œæ´¾å‘å‡½æ•°è°ƒç”¨çš„è¡¨ã€‚è°ƒç”¨æˆå‘˜æ–¹æ³•æ—¶ï¼Œthis æŒ‡é’ˆä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ä¼ å…¥ï¼Œä¾›æˆå‘˜å‡½æ•°è®¿é—®ç›¸åº”çš„å®ä¾‹æ•°æ®ã€‚

ä»¥ä¸‹ç¤ºèŒƒä»£ç ä¸­ï¼Œè¡¨ç¤ºäº†ç¼–è¯‘å™¨éšå«çš„æ“ä½œï¼Œå®ƒä¼šåœ¨é¡¶å±‚åŸºç±»å†…å­˜å¼€å§‹åœ°å€å¤„æ”¾ç½®ä¸€ä¸ªè™šå‡½æ•°è¡¨æŒ‡é’ˆï¼š

```cpp
class Base
{
public:
    VirtualTable* __vptr;
    virtual void function1() {};
    virtual void function2() {};
};
```

åœ¨ MSVC ç¼–è¯‘å™¨ä¸­ï¼Œä¸€ä¸ªç±»ä½¿ç”¨è™šå‡½æ•°è¡¨æ–¹å¼å¦‚ä¸‹ï¼Œæ ¹æ®å•ä¸€ç»§æ‰¿ã€å¤šç»§æ‰¿ï¼Œå’Œæ˜¯å¦ä½¿ç”¨è™šç»§æ‰¿è¿›è¡ŒåŒºåˆ«ï¼Œè¿™é‡Œåªè®¨è®ºä¸¤å±‚ç»§æ‰¿ï¼š

- éè™šå•ç»§æ‰¿ï¼Œåªè¦ç±»æœ¬èº«æˆ–çˆ¶ç±»åªè¦ä½¿ç”¨äº†è™šå‡½æ•°ï¼Œå°±éœ€è¦ä½¿ç”¨ä¸€å¼ è™šå‡½æ•°è¡¨ï¼Œè¡¨ä¸­æ¡ç›®æŒ‰è™šå‡½æ•°åœ¨ç±»ä¸­çš„å£°æ˜é¡ºåºæ’åˆ—ï¼ŒåŸºç±»ä¼˜å…ˆï¼ŒåŒ…æ‹¬ç§æœ‰çš„è™šå‡½æ•°ï¼›
- è™šå•ä¸€ç»§æ‰¿ï¼Œåªè¦ç±»æœ¬èº«æˆ–çˆ¶ç±»åªè¦ä½¿ç”¨äº†è™šå‡½æ•°ï¼Œéƒ½ç‹¬ç«‹ä¸€å¼ è™šå‡½æ•°è¡¨ç®¡ç†ï¼Œå› æ²¡æœ‰å…¶å®ƒåŸºç±»ï¼Œæ‰€ä»¥å­ç±»ä¸ç”¨å’Œå…¶å®ƒéè™šåŸºç±»å…±ç”¨è™šå‡½æ•°è¡¨ã€‚
- éè™šå¤šç»§æ‰¿ï¼Œå­ç±»å’Œé¦–ä¸ªä½¿ç”¨äº†è™šå‡½æ•°çš„åŸºç±»å…±ç”¨è™šå‡½æ•°è¡¨ï¼Œå…¶å®ƒåŸºç±»ä½¿ç”¨ç‹¬ç«‹è™šå‡½è¡¨ï¼Œå¦‚æœæœ‰ä½¿ç”¨è™šå‡½æ•°ï¼›

è™šæ‹Ÿå¤šç»§æ‰¿æƒ…å½¢åˆ†å¼€è®¨è®ºï¼Œä¸»è¦åŒºåˆ«åœ¨äºæ˜¯å¦ä½¿ç”¨è™šç»§æ‰¿ï¼Œå¦‚æœä½¿ç”¨è™šç»§æ‰¿ï¼Œç±»æœ¬èº«å’ŒåŸºç±»è™šå‡½æ•°åˆ†è¡¨ç®¡ç†ã€‚æ‰€æœ‰å¯èƒ½å­˜åœ¨çš„è™šåŸºç±»éƒ½é€šè¿‡ä¸€å¼  vbtable è¡¨ç®¡ç†ã€‚

- å­ç±»ã€åŸºç±»éƒ½æ²¡æœ‰ä½¿ç”¨è™šå‡½æ•°çš„è™šç»§æ‰¿å¾ˆç®€å•ï¼Œåªæœ‰ vbtable æ¥ç®¡ç†è™šåŸºç±»ï¼Œæ²¡æœ‰è™šå‡½æ•°è¡¨ï¼Œå› ä¸ºä¸éœ€è¦ã€‚
- åªåœ¨å­ç±»ä½¿ç”¨è™šå‡½æ•°çš„æƒ…å†µï¼Œåªæœ‰å­ç±»ä¸€å¼ è™šå‡½æ•°è¡¨ã€‚
- åªåœ¨åŸºç±»ä½¿ç”¨è™šå‡½æ•°çš„æƒ…å†µï¼Œæ ¹æ®ä½¿ç”¨äº†è™šå‡½æ•°çš„åŸºæ•°åœ¨åˆ—è¡¨çš„é¡ºåºè®¾ç½®è™šå‡½æ•°è¡¨ã€‚å› ä¸ºåªä¼šæœ‰ä¸€å¼  vbtableï¼Œåªæœ‰åœ¨ç¬¬ä¸€ä¸ªè™šç»§æ‰¿çš„åŸºç±»çš„è™šå‡½æ•°è¡¨å‰æ”¾ç½®ï¼Œå¦‚æœå®ƒæœ‰ä½¿ç”¨è™šå‡½æ•°è¡¨ã€‚
- å­ç±»ã€åŸºç±»éƒ½æœ‰ä½¿ç”¨è™šå‡½æ•°çš„æƒ…å†µï¼Œå­ç±»ä¼šå’Œè™šç»§æ‰¿å‰é¢çš„åŸºç±»å…±åŒåŒä¸€å¼ è™šå‡½æ•°è¡¨ï¼Œå¦‚æœå‰é¢æœ‰ä½¿ç”¨äº†è™šå‡½æ•°çš„åŸºç±»ã€‚åç»§çš„åŸºç±»æŒ‰ç»§æ‰¿åˆ—è¡¨é¡ºåºè®¾ç½®è™šå‡½æ•°è¡¨ã€‚ä¼šåœ¨ç¬¬ä¸€ä¸ªè™šåŸºç±»çš„è™šå‡½æ•°è¡¨å‰ä¼šè®¾ç½®ä¸€å¼  vbtableï¼Œå’Œå…¶å®ƒè™šåŸºç±»å…±ç”¨ã€‚

åœ¨å¤šå±‚çš„è™šæ‹Ÿç»§æ‰¿ç»“æ„ä¸­ï¼Œvbtable ä¼šæœ‰å¤šå¼ ï¼Œå–å†³äºæœ‰å¤šå°‘å±‚æ¬¡æ·±åº¦ï¼Œå’Œè™šç»§æ‰¿å…³ç³»æ•°é‡ã€‚

å„ç§ç°ä»£ç¼–è¯‘éƒ½æä¾›äº†æ‰“å° C++ ç±»å¯¹è±¡æ•°æ®å†…å­˜å¸ƒå±€çš„å·¥å…·ï¼š

    cl.exe source.cpp /d1reportSingleClassLayout<CLASSNAME>
    cl.exe source.cpp /d1reportAllClassLayout
    gcc --fdump-class-hierarchy source.cpp
    clang -Xclang -fdump-record-layouts source.cpp

è¾“å‡ºæ ¼å¼ä¸ä¸€æ ·ï¼Œä»¥ MSVC ç¼–è¯‘å™¨çš„è¾“å‡ºä¸ºå‚è€ƒï¼Œå°†å‰é¢å°èŠ‚çš„ç¤ºèŒƒç±»å‹å±‚æ¬¡ç»“æ„æ‰“å°å‡ºæ¥ï¼Œä»¥ä¸‹æ˜¯æ²¡æœ‰è™šç»§æ‰¿æ—¶ä¸¤å±‚ç»§æ‰¿çš„å†…å­˜å¸ƒå±€ï¼š

    **********************************************************************
    ** Visual Studio 2019 Developer Command Prompt v16.6.1
    ** Copyright (c) 2020 Microsoft Corporation
    **********************************************************************
    [vcvarsall.bat] Environment initialized for: 'x64'
    ç”¨äº x64 çš„ Microsoft (R) C/C++ ä¼˜åŒ–ç¼–è¯‘å™¨ 19.26.28806 ç‰ˆ
    ç‰ˆæƒæ‰€æœ‰(C) Microsoft Corporationã€‚ä¿ç•™æ‰€æœ‰æƒåˆ©ã€‚

    class XMan  size(16):
        +---
     0  | +--- (base class MI)
     0  | | +--- (base class VMan1)
     0  | | | +--- (base class HumanBeing)
     0  | | | | {vfptr}
        | | | +---
        | | +---
     8  | | +--- (base class VMan2)
     8  | | | +--- (base class HumanBeing)
     8  | | | | {vfptr}
        | | | +---
        | | +---
        | +---
        +---

    XMan::$vftable@VMan1@:
        | &XMan_meta
        |  0
     0  | &MI::vf 
     1  | &XMan::{dtor} 

    XMan::$vftable@VMan2@:
        | -8
     0  | &thunk: this-=8; goto MI::vf 
     1  | &thunk: this-=8; goto XMan::{dtor} 

    XMan::{dtor} this adjustor: 0
    XMan::__delDtor this adjustor: 0
    XMan::__vecDelDtor this adjustor: 0

ä»æ‰“å°å‡ºæ¥çš„å†…å­˜å¸ƒå±€ä¿¡æ¯å¯ä»¥çœ‹åˆ°ï¼ŒHumanBeing æœ‰ä¸¤ä¸ªå‰¯æœ¬å¯¹è±¡ã€‚XMan å®ä¾‹ä¸»ä½“å  16-Byteï¼ŒåŒ…å«è‡ªèº«çš„æ•°æ®æˆå‘˜å’Œä¸¤ä¸ªç›´æ¥åŸºç±»çš„æ•°æ®æˆå‘˜ã€‚å› ä¸ºä½¿ç”¨äº†è™šå‡½æ•°ï¼Œæ‰€ä»¥é…ç½®äº†ç›¸åº”çš„ Virtual Tableï¼Œæ¯ä¸ªç›´æ¥çˆ¶ç±»å¯¹åº”ä¸€ä¸ªï¼Œä½¿ç”¨ vfptr æŒ‡é’ˆå¼•ç”¨ã€‚

åŒ…å«çº¯è™šå‡½æ•°çš„åŸºç±» HumanBeing æ˜¯æŠ½è±¡ç±»ï¼Œä¸èƒ½ç›´æ¥ä½¿ç”¨ä»£ç æ¥å®ä¾‹åŒ–ï¼Œæ‰€ä»¥ MSVC æ²¡æœ‰æ‰“å°ç›¸åº”çš„å†…å­˜å¸ƒå±€ï¼ŒåªåµŒå…¥å­ç±»çš„å†…å­˜å¸ƒå±€ä¸­ã€‚

å…¶å®ƒæ™®é€šçš„ç±»æ–¹æ³•æˆå‘˜æœ‰ä¸“ç”¨çš„åœ°å€ï¼Œä¸ä¼šåœ¨è™šè¡¨ä¸­è®°å½•ï¼Œä¹Ÿä¸ä¼šåœ¨å¯¹è±¡çš„æ•°æ®å†…å­˜å¸ƒå±€ä¸­è®°å½•ã€‚

ç‰¹å®šæƒ…å†µå¯ä»¥çœ‹åˆ°è™šå‡½æ•°è¡¨ä¸­æœ‰ä¸¤ä¸ªææ„å‡½æ•°ï¼Œåœ¨ MSVC ç”Ÿæˆçš„å†…å­˜å¸ƒå±€ä¿¡æ¯ä¸­ä¼šç”¨ deleting å’Œ complete åç¼€æ ‡è®°ï¼Œå› ä¸ºå¯¹è±¡æœ‰ä¸¤ç§æ„é€ æ–¹å¼ï¼Œæ ˆæ„é€ å’Œå †æ„é€ ã€‚æ‰€ä»¥å¯¹åº”å¯¹è±¡ä¹Ÿæœ‰ä¸¤ç§ææ„æ–¹å¼ã€‚å·®åˆ«åœ¨äºï¼Œå †ä¸Šå¯¹è±¡çš„ææ„éœ€è¦æ‰‹åŠ¨ç®¡ç†ï¼Œè€Œæ ˆå†…å­˜çš„å¯¹è±¡ææ„ä¸éœ€è¦æ‰§è¡Œ delete å‡½æ•°ï¼Œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨å¤„ç†å›æ”¶é—®é¢˜ã€‚

ä»¥ä¸‹æ˜¯ä¸¤å±‚çš„è™šç»§æ‰¿çš„ç±»æ•°æ®ç»“æ„ï¼ŒåŒæ—¶æœ‰ä¸¤å¼  vbtable å¯¹åº”ä¸¤ä¸ªç›´æ¥åŸºç±»çš„è™šç»§æ‰¿ã€‚æœ€ä¸»è¦çš„æ˜¯ HumanBeing åœ¨å†…å­˜ä¸­åªæœ‰ä¸€ä¸ªå‰¯æœ¬ï¼Œè¿™å°±æ˜¯è™šç»§æ‰¿çš„è®¾è®¡çš„ç›®çš„ï¼š

    class XMan  size(32):
        +---
     0  | +--- (base class MI)
     0  | | +--- (base class VMan1)
     0  | | | {vbptr}
        | | | <alignment member> (size=4)
        | | +---
     8  | | +--- (base class VMan2)
     8  | | | {vbptr}
        | | | <alignment member> (size=4)
        | | +---
        | | <alignment member> (size=4)
        | +---
        | <alignment member> (size=4)
        +---
    20  | (vtordisp for vbase HumanBeing)
        +--- (virtual base HumanBeing)
    24  | {vfptr}
        +---

    XMan::$vbtable@VMan1@:
     0  | 0
     1  | 24 (XMand(VMan1+0)HumanBeing)

    XMan::$vbtable@VMan2@:
     0  | 0
     1  | 16 (XMand(VMan2+0)HumanBeing)

    XMan::$vftable@:
        | -24
     0  | &(vtordisp) MI::vf 
     1  | &(vtordisp) XMan::{dtor} 

    XMan::{dtor} this adjustor: 24
    XMan::__delDtor this adjustor: 24
    XMan::__vecDelDtor this adjustor: 24
    vbi:       class  offset o.vbptr  o.vbte fVtorDisp
          HumanBeing      24       0       4 1

GCC ç¼–è¯‘å™¨ï¼Œå¯ä»¥ä½¿ç”¨ -fdump-class-hierarchy é€‰é¡¹è¿›è¡Œç¼–è¯‘ä¼šå¾—åˆ°ä¸€ä¸ª .class ç±»ç»“æ„ä¿¡æ¯æ–‡ä»¶ï¼Œä»¥ä¸‹æ˜¯åŒæ ·æºä»£ç äº§ç”Ÿç±»å±‚æ¬¡å¸ƒå±€ï¼Œåªæ‘˜å– XMan ç›¸å…³éƒ¨åˆ†ã€‚

åœ¨è™šç»§æ‰¿ä¸­ï¼ŒGCC ç¼–è¯‘å™¨è¿˜ä¼šä¸ºå­ç±»å¤šç”Ÿæˆä¸€ä¸ªè™šè¡¨æ•°æ®è¡¨ VTT(virtual table table)ï¼Œè¿™å¼ è¡¨è®°å½•äº†è™šç»§æ‰¿ç±»çš„è™šè¡¨åœ°å€ã€‚

æ˜¾ç¤ºï¼Œä¸¤ç§ç¼–è¯‘å™¨å¤„ç†è™šå‡½æ•°çš„å·¥ä½œæ–¹å¼å®Œå…¨ä¸åŒï¼š

    VTT for XMan
    XMan::_ZTT4XMan: 10u entries
    0     ((& XMan::_ZTV4XMan) + 20u)
    4     ((& XMan::_ZTC4XMan0_2MI) + 20u)
    8     ((& XMan::_ZTC4XMan0_5VMan1) + 20u)
    12    ((& XMan::_ZTC4XMan0_5VMan1) + 20u)
    16    ((& XMan::_ZTC4XMan4_5VMan2) + 20u)
    20    ((& XMan::_ZTC4XMan4_5VMan2) + 48u)
    24    ((& XMan::_ZTC4XMan0_2MI) + 20u)
    28    ((& XMan::_ZTC4XMan0_2MI) + 52u)
    32    ((& XMan::_ZTV4XMan) + 20u)
    36    ((& XMan::_ZTV4XMan) + 52u)

    Class XMan
       size=8 align=4
       base size=8 base align=4
    XMan (0x0x5c4b040) 0
        vptridx=0u vptr=((& XMan::_ZTV4XMan) + 20u)
      MI (0x0x5c4b080) 0
          primary-for XMan (0x0x5c4b040)
          subvttidx=4u
        VMan1 (0x0x5c4b0c0) 0 nearly-empty
            primary-for MI (0x0x5c4b080)
            subvttidx=8u
          HumanBeing (0x0x5c423f0) 0 nearly-empty virtual
              primary-for VMan1 (0x0x5c4b0c0)
              vptridx=32u vbaseoffset=-20
        VMan2 (0x0x5c4b100) 4 nearly-empty
            lost-primary
            subvttidx=16u vptridx=36u vptr=((& XMan::_ZTV4XMan) + 52u)
          HumanBeing (0x0x5c423f0) alternative-path

    Vtable for XMan
    XMan::_ZTV4XMan: 16u entries
    0     0u
    4     0u
    8     0u
    12    (int (*)(...))0
    16    (int (*)(...))(& _ZTI4XMan)
    20    (int (*)(...))MI::vf
    24    (int (*)(...))XMan::~XMan
    28    (int (*)(...))XMan::~XMan
    32    4294967292u
    36    4294967292u
    40    4294967292u
    44    (int (*)(...))-4
    48    (int (*)(...))(& _ZTI4XMan)
    52    (int (*)(...))MI::_ZThn4_NK2MI2vfEv
    56    (int (*)(...))XMan::_ZThn4_N4XManD1Ev
    60    (int (*)(...))XMan::_ZThn4_N4XManD0Ev

    Construction vtable for MI (0x0x5c4b080 instance) in XMan
    XMan::_ZTC4XMan0_2MI: 16u entries
    0     0u
    4     0u
    8     0u
    12    (int (*)(...))0
    16    (int (*)(...))(& _ZTI2MI)
    20    (int (*)(...))MI::vf
    24    0u
    28    0u
    32    4294967292u
    36    4294967292u
    40    4294967292u
    44    (int (*)(...))-4
    48    (int (*)(...))(& _ZTI2MI)
    52    (int (*)(...))MI::_ZThn4_NK2MI2vfEv
    56    0u
    60    0u

    Construction vtable for VMan1 (0x0x5c4b0c0 instance) in XMan
    XMan::_ZTC4XMan0_5VMan1: 8u entries
    0     0u
    4     0u
    8     0u
    12    (int (*)(...))0
    16    (int (*)(...))(& _ZTI5VMan1)
    20    (int (*)(...))VMan1::vf
    24    0u
    28    0u

    Construction vtable for VMan2 (0x0x5c4b100 instance) in XMan
    XMan::_ZTC4XMan4_5VMan2: 15u entries
    0     4294967292u
    4     0u
    8     0u
    12    (int (*)(...))0
    16    (int (*)(...))(& _ZTI5VMan2)
    20    (int (*)(...))VMan2::vf
    24    0u
    28    0u
    32    4u
    36    4u
    40    (int (*)(...))4
    44    (int (*)(...))(& _ZTI5VMan2)
    48    (int (*)(...))VMan2::_ZTv0_n12_NK5VMan22vfEv
    52    0u
    56    0u

